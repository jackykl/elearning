<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://fonts.googleapis.com; font-src 'self' https://cdn.jsdelivr.net https://fonts.gstatic.com; img-src 'self' data: https: https://cdn.jsdelivr.net; connect-src 'self' https://script.google.com https://script.googleusercontent.com https://docs.google.com https://*.googleusercontent.com https://cdn.jsdelivr.net; frame-src 'none'; object-src 'none'; base-uri 'self'; worker-src 'self' blob:; child-src 'self' blob:;">
  <meta name="referrer" content="no-referrer">
  <title>ç·šä¸Šå­¸ç¿’å¹³å°</title>

  <!-- å¼•å…¥ Ionic çš„æ ¸å¿ƒ CSS å’Œ JS (CDN) -->
  <script type="module" src="https://cdn.jsdelivr.net/npm/@ionic/core/dist/ionic/ionic.esm.js"></script>
  <script nomodule src="https://cdn.jsdelivr.net/npm/@ionic/core/dist/ionic/ionic.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@ionic/core/css/ionic.bundle.css" />

  <style>
    /* å…¨å±€é«˜åº¦è¨­ç½® - ç¢ºä¿å……åˆ†åˆ©ç”¨è¦–å£é«˜åº¦ */
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      overflow: hidden;
    }

    ion-app {
      height: 100vh;
    }

    ion-content {
      height: 100%;
      --padding-top: 0;
      --padding-bottom: 0; /* ä¸éœ€è¦ paddingï¼Œå› ç‚ºç‰ˆæ¬Šè³‡è¨Šæ˜¯ fixed å®šä½ï¼Œå…§å®¹é«˜åº¦å·²è¨ˆç®— */
    }

    /* è‡ªå®šç¾©æ¨£å¼èª¿æ•´ */
    :root {
      --ion-color-primary: #3b82f6; /* é¡ä¼¼ Tailwind çš„ Blue-500 */
      --ion-background-color: #f3f4f6;
    }

    .quiz-container {
      max-width: 600px;
      margin: 0 auto;
      height: 100%;
      min-height: 100%;
      display: flex;
      flex-direction: column;
    }

    /* ç·´ç¿’é¸æ“‡ç•«é¢æ™‚ï¼Œå®¹å™¨éœ€è¦å……åˆ†åˆ©ç”¨é«˜åº¦ */
    #practice-select-screen .quiz-container {
      height: 100vh !important;
      min-height: 100vh !important;
    }

    /* ç•¶é¡¯ç¤ºç·´ç¿’é¸æ“‡ç•«é¢æˆ–æ¸¬é©—ç•«é¢æ™‚ï¼Œç§»é™¤å®¹å™¨å¯¬åº¦é™åˆ¶ */
    .quiz-container:has(#practice-select-screen:not(.hidden)),
    .quiz-container:has(#quiz-screen:not(.hidden)) {
      max-width: 100% !important;
      width: 100% !important;
    }

    /* ç·´ç¿’é¸æ“‡ç•«é¢æ™‚ç§»é™¤å¯¬åº¦é™åˆ¶ä¸¦å……åˆ†åˆ©ç”¨é«˜åº¦ */
    #practice-select-screen {
      width: 100% !important;
      max-width: 100% !important;
      height: calc(100vh - 80px) !important; /* æ¸›å»ç‰ˆæ¬Šè³‡è¨Šé«˜åº¦ */
      min-height: calc(100vh - 80px) !important;
      max-height: calc(100vh - 80px) !important;
      margin: 0 !important;
      padding: 0 !important;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* æ¸¬é©—ç•«é¢æ™‚ç§»é™¤å¯¬åº¦é™åˆ¶ä¸¦å……åˆ†åˆ©ç”¨é«˜åº¦ */
    #quiz-screen {
      width: 100% !important;
      max-width: 100% !important;
      height: calc(100vh - 80px) !important; /* æ¸›å»ç‰ˆæ¬Šè³‡è¨Šé«˜åº¦ */
      min-height: calc(100vh - 80px) !important;
      margin: 0 !important;
      padding: 0 !important;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* é¸é …æŒ‰éˆ•æ¨£å¼ */
    .option-card {
      margin: 10px 0;
      cursor: pointer;
      border: 2px solid transparent;
      transition: all 0.2s;
    }
    
    /* é¸ä¸­ç‹€æ…‹ */
    .option-card.selected {
      border-color: var(--ion-color-primary);
      background-color: #eff6ff;
    }

    /* æ­£ç¢ºç­”æ¡ˆæ¨£å¼ */
    .option-card.correct {
      border-color: var(--ion-color-success);
      background-color: #f0fdf4;
      color: var(--ion-color-success-shade);
    }

    /* éŒ¯èª¤ç­”æ¡ˆæ¨£å¼ */
    .option-card.wrong {
      border-color: var(--ion-color-danger);
      background-color: #fef2f2;
      color: var(--ion-color-danger-shade);
    }

    /* éš±è—å€å¡Š */
    .hidden {
      display: none !important;
    }

    /* è§£æå€å¡Šå‹•ç•« */
    #feedback-area {
      transition: opacity 0.3s ease-in;
      margin: 20px 0 !important;
      min-height: 60px; /* ç¢ºä¿æœ‰è¶³å¤ é«˜åº¦ */
      flex-shrink: 0; /* é˜²æ­¢è¢«å£“ç¸® */
    }

    /* ç¢ºä¿åé¥‹å€åŸŸé¡¯ç¤ºæ™‚å¯è¦‹ */
    #feedback-area:not(.hidden) {
      display: block !important;
      visibility: visible !important;
      opacity: 1 !important;
    }

    /* ç¢ºä¿åé¥‹æ–‡æœ¬å¯è¦‹ */
    #feedback-text {
      display: block !important;
      min-height: 1.5em;
      white-space: pre-wrap; /* å…è¨±æ›è¡Œ */
      word-wrap: break-word; /* é•·å–®è©æ›è¡Œ */
      overflow-wrap: break-word;
      padding: 8px 0; /* å¢åŠ å…§é‚Šè· */
      line-height: 1.6; /* å¢åŠ è¡Œé«˜ï¼Œæé«˜å¯è®€æ€§ */
      max-height: none !important; /* ä¸é™åˆ¶æœ€å¤§é«˜åº¦ */
      overflow: visible !important; /* ç¢ºä¿å…§å®¹å¯è¦‹ */
    }

    /* ç¢ºä¿åé¥‹å€åŸŸå…§å®¹ä¸è¢«å£“ç¸® */
    #feedback-area ion-card-content {
      padding: 16px !important;
      min-height: 50px;
    }
    
    /* ç¢ºä¿å•é¡Œæ–‡å­—å€åŸŸæœ‰è¶³å¤ ç©ºé–“ï¼Œä¸è¢«å£“ç¸®ï¼Œä¸”å§‹çµ‚å¯è¦‹ */
    #question-text {
      flex-shrink: 0 !important;
      display: block !important;
      visibility: visible !important;
      opacity: 1 !important;
      line-height: 1.6 !important;
      word-wrap: break-word !important;
      overflow-wrap: break-word !important;
      white-space: normal !important;
      min-height: 2em !important;
      padding: 10px 0 !important;
      overflow: visible !important;
      max-height: none !important;
    }
    
    /* ç¢ºä¿å•é¡Œå¡ç‰‡å§‹çµ‚å¯è¦‹ä¸”ä¸è¢«å£“ç¸® */
    ion-card:has(#question-text) {
      display: block !important;
      visibility: visible !important;
      opacity: 1 !important;
      flex-shrink: 0 !important;
      overflow: visible !important;
    }

    /* ç·´ç¿’é¸æ“‡å¡ç‰‡æ¨£å¼ */
    .practice-card {
      margin: 10px 0;
      cursor: pointer;
      transition: all 0.2s;
    }

    .practice-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    /* å¯†ç¢¼è¼¸å…¥å€åŸŸ */
    .password-container {
      max-width: 400px;
      margin: 0 auto;
    }

    /* é˜²æ­¢æ–‡æœ¬é¸æ“‡ï¼ˆæ¸¬é©—å…§å®¹ä¿è­·ï¼‰ */
    .protected-content {
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
      -webkit-touch-callout: none;
    }

    /* æ°´å°æ¨£å¼ */
    .watermark {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) rotate(-45deg);
      font-size: 3rem;
      color: rgba(0, 0, 0, 0.05);
      pointer-events: none;
      z-index: 9999;
      white-space: nowrap;
      font-weight: bold;
    }

    /* ç¦æ­¢é¸æ“‡çš„è¦†è“‹å±¤ */
    body.no-select {
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
    }

    /* ç·´ç¿’é¸æ“‡ç•«é¢å¸ƒå±€ - å……åˆ†åˆ©ç”¨å±å¹•å¯¬åº¦å’Œé«˜åº¦ */
    .practice-select-layout {
      display: flex;
      gap: 20px;
      height: calc(100vh - 80px); /* æ¸›å»ç‰ˆæ¬Šè³‡è¨Šé«˜åº¦ */
      min-height: calc(100vh - 80px);
      max-height: calc(100vh - 80px);
      padding: 20px;
      width: 100%;
      max-width: 100%;
      box-sizing: border-box;
      margin: 0;
      overflow: hidden;
      flex: 1;
    }

    .practice-sidebar {
      flex: 0 0 320px;
      min-width: 280px;
      max-width: 380px;
      border-right: 2px solid #e0e0e0;
      padding-right: 20px;
      overflow-y: auto;
      height: 100%;
      max-height: 100%;
      flex-shrink: 0;
      box-sizing: border-box;
    }

    .leaderboard-main {
      flex: 1;
      min-width: 0;
      overflow-y: auto;
      overflow-x: hidden;
      padding-left: 20px;
      padding-right: 20px; /* ç‚ºæ»¾å‹•æ¢é ç•™ç©ºé–“ï¼Œé¿å…å…§å®¹è¢«é®æ“‹ */
      padding-bottom: 0; /* ç§»é™¤åº•éƒ¨å…§é‚Šè·ï¼Œå› ç‚ºå·²ç¶“åœ¨ layout å±¤é¢è™•ç† */
      height: 100%;
      max-height: 100%;
      width: 100%;
      max-width: 100%;
      box-sizing: border-box;
      flex-grow: 1;
      /* ä½¿ç”¨ overlay æ»¾å‹•æ¢ï¼Œä¸å ç”¨å…§å®¹ç©ºé–“ */
      scrollbar-gutter: stable;
    }
    
    /* è‡ªå®šç¾©æ»¾å‹•æ¢æ¨£å¼ï¼Œä½¿å…¶ä¸å ç”¨å…§å®¹ç©ºé–“ï¼ˆWebKit ç€è¦½å™¨ï¼‰ */
    .leaderboard-main::-webkit-scrollbar {
      width: 8px;
    }
    
    .leaderboard-main::-webkit-scrollbar-track {
      background: transparent;
    }
    
    .leaderboard-main::-webkit-scrollbar-thumb {
      background: rgba(0, 0, 0, 0.2);
      border-radius: 4px;
    }
    
    .leaderboard-main::-webkit-scrollbar-thumb:hover {
      background: rgba(0, 0, 0, 0.3);
    }

    /* å´é‚Šæ¬„ç·´ç¿’å¡ç‰‡æ¨£å¼å„ªåŒ– */
    .practice-sidebar .practice-card {
      margin-bottom: 12px;
    }

    .practice-sidebar .practice-card ion-card-content {
      padding: 12px;
    }

    /* æ’è¡Œæ¦œä¸»å…§å®¹å€åŸŸæ¨£å¼ */
    .leaderboard-main {
      width: 100%;
    }

    .leaderboard-main h2 {
      color: #1f2937;
      font-weight: 600;
      margin-bottom: 25px;
    }

    .leaderboard-main #leaderboard-container {
      width: 100%;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 15px;
      align-items: start;
      overflow: visible; /* å…è¨±å…§å®¹å®Œæ•´é¡¯ç¤º */
      padding-bottom: 10px; /* æ·»åŠ åº•éƒ¨é–“è·ï¼Œç¢ºä¿æœ€å¾Œä¸€è¡Œå¡ç‰‡ä¸è¢«å‰ªè£ */
      padding-right: 0; /* ä¸éœ€è¦é¡å¤–å³å´ paddingï¼Œå·²åœ¨ .leaderboard-main ä¸­è™•ç† */
      box-sizing: border-box;
    }

    .leaderboard-main .ion-card {
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      border-radius: 8px;
      width: 100%;
      margin-bottom: 0;
      max-height: none; /* ç§»é™¤æœ€å¤§é«˜åº¦é™åˆ¶ï¼Œå…è¨±å…§å®¹å®Œæ•´é¡¯ç¤º */
      min-height: 280px;
      display: flex;
      flex-direction: column;
      overflow: visible; /* æ”¹ç‚º visibleï¼Œå…è¨±å…§å®¹å®Œæ•´é¡¯ç¤º */
      aspect-ratio: auto; /* ç§»é™¤å›ºå®šæ¯”ä¾‹ï¼Œå…è¨±æ ¹æ“šå…§å®¹èª¿æ•´ */
      box-sizing: border-box; /* ç¢ºä¿å¯¬åº¦è¨ˆç®—åŒ…å« padding å’Œ border */
    }

    .leaderboard-main .ion-card-header {
      background-color: #f8f9fa;
      border-bottom: 1px solid #e0e0e0;
      flex-shrink: 0;
    }

    .leaderboard-main .ion-card-title {
      color: #1f2937;
      font-weight: 600;
      font-size: 1em;
      padding: 12px 16px;
    }

    .leaderboard-main .ion-card-content {
      flex: 1;
      overflow-y: auto;
      overflow-x: visible; /* å…è¨±æ°´å¹³æ–¹å‘å…§å®¹å®Œæ•´é¡¯ç¤º */
      min-height: 0;
      padding: 8px 12px;
      max-height: none; /* ç§»é™¤æœ€å¤§é«˜åº¦é™åˆ¶ */
    }

    .leaderboard-main .ion-list {
      width: 100%;
    }

    .leaderboard-main .ion-item {
      width: 100%;
    }

    /* éŸ¿æ‡‰å¼è¨­è¨ˆ - æ’è¡Œæ¦œç¶²æ ¼ */
    @media (max-width: 1400px) {
      .leaderboard-main #leaderboard-container {
        grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
      }
    }

    @media (max-width: 1000px) {
      .leaderboard-main #leaderboard-container {
        grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
        gap: 12px;
      }
    }

    @media (max-width: 768px) {
      .leaderboard-main #leaderboard-container {
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 10px;
      }
      
      .leaderboard-main .ion-card {
        max-height: none;
        min-height: 200px;
      }
    }

    @media (max-width: 480px) {
      .leaderboard-main #leaderboard-container {
        grid-template-columns: 1fr;
      }
    }

    /* æ‰‹æ©Ÿç‰ˆå´é‚Šèœå–®æ¨£å¼ */
    .mobile-menu-toggle {
      display: none; /* é»˜èªéš±è—ï¼Œåªåœ¨æ‰‹æ©Ÿç‰ˆé¡¯ç¤º */
      position: fixed;
      top: 15px;
      left: 15px;
      z-index: 1001;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 50%;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    }
    
    .menu-overlay {
      display: none; /* é»˜èªéš±è— */
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 999;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    
    .menu-overlay.active {
      display: block;
      opacity: 1;
    }
    
    .mobile-menu-header {
      display: none; /* é»˜èªéš±è—ï¼Œåªåœ¨æ‰‹æ©Ÿç‰ˆé¡¯ç¤º */
      align-items: center;
      justify-content: space-between;
      padding: 15px;
      border-bottom: 1px solid #e0e0e0;
      margin-bottom: 15px;
    }
    
    .mobile-menu-close {
      display: none; /* é»˜èªéš±è—ï¼Œåªåœ¨æ‰‹æ©Ÿç‰ˆé¡¯ç¤º */
    }

    /* éŸ¿æ‡‰å¼è¨­è¨ˆ - æ‰‹æ©Ÿç‰ˆå´é‚Šèœå–® */
    @media (max-width: 768px) {
      .mobile-menu-toggle {
        display: block; /* æ‰‹æ©Ÿç‰ˆé¡¯ç¤ºèœå–®æŒ‰éˆ• */
      }
      
      .practice-select-layout {
        flex-direction: row; /* ä¿æŒæ©«å‘å¸ƒå±€ï¼Œä½†å´é‚Šæ¬„æœƒéš±è— */
        padding: 15px;
        height: 100%;
        min-height: 100%;
        position: relative;
      }

      .practice-sidebar {
        position: fixed;
        top: 0;
        left: -100%; /* é»˜èªéš±è—åœ¨å·¦å´ */
        width: 280px;
        max-width: 85vw; /* æœ€å¤§å¯¬åº¦ç‚ºè¦–å£å¯¬åº¦çš„85% */
        height: calc(100vh - 80px); /* æ¸›å»ç‰ˆæ¬Šè³‡è¨Šé«˜åº¦ */
        max-height: calc(100vh - 80px);
        background: white;
        z-index: 1000;
        box-shadow: 2px 0 8px rgba(0, 0, 0, 0.15);
        transition: left 0.3s ease;
        border-right: 2px solid #e0e0e0;
        padding: 0; /* ç§»é™¤ paddingï¼Œæ”¹ç‚ºå…§éƒ¨å…ƒç´ æ§åˆ¶ */
        overflow: hidden; /* æ”¹ç‚º hiddenï¼Œè®“å…§éƒ¨å…ƒç´ æ§åˆ¶æ»¾å‹• */
        flex: none;
        margin: 0;
        display: flex;
        flex-direction: column;
      }
      
      /* æ‰‹æ©Ÿç‰ˆç·´ç¿’ç›®éŒ„å´é‚Šæ¬„å…§å®¹å€åŸŸå¸ƒå±€ */
      .practice-sidebar .mobile-menu-header {
        padding: 15px 20px;
        flex-shrink: 0;
        border-bottom: 1px solid #e0e0e0;
      }
      
      .practice-sidebar > div:not(.mobile-menu-header):not(#practice-list) {
        padding: 15px 20px 0 20px;
        flex-shrink: 0;
      }
      
      .practice-sidebar #practice-list {
        flex: 1;
        overflow-y: auto;
        overflow-x: hidden;
        min-height: 0;
        padding: 15px 20px; /* å·¦å³å’Œä¸Šä¸‹æ·»åŠ  padding */
        max-height: none !important; /* ç§»é™¤æœ€å¤§é«˜åº¦é™åˆ¶ï¼Œå……åˆ†åˆ©ç”¨ç©ºé–“ */
      }
      
      /* ç™»å‡ºæŒ‰éˆ•å€åŸŸ */
      .practice-sidebar > ion-button {
        padding: 15px 20px 20px 20px;
        flex-shrink: 0;
        margin: 0;
        margin-top: auto; /* æ¨åˆ°åº•éƒ¨ */
      }
      
      .practice-sidebar.menu-open {
        left: 0; /* æ‰“é–‹æ™‚é¡¯ç¤º */
      }
      
      .mobile-menu-header {
        display: flex; /* æ‰‹æ©Ÿç‰ˆé¡¯ç¤ºèœå–®æ¨™é¡Œå’Œé—œé–‰æŒ‰éˆ• */
      }
      
      .mobile-menu-close {
        display: block; /* æ‰‹æ©Ÿç‰ˆé¡¯ç¤ºé—œé–‰æŒ‰éˆ• */
      }

      .leaderboard-main {
        padding-left: 15px;
        padding-right: 15px;
        height: auto;
        flex: 1;
        min-height: 0;
        overflow-y: auto;
        width: 100%;
      }
      
      /* æ¸¬é©—ç•«é¢çš„å´é‚Šæ¬„ */
      .quiz-sidebar {
        position: fixed;
        top: 0;
        left: -100%; /* é»˜èªéš±è—åœ¨å·¦å´ */
        width: 280px;
        max-width: 85vw;
        height: calc(100vh - 80px); /* æ¸›å»ç‰ˆæ¬Šè³‡è¨Šé«˜åº¦ */
        max-height: calc(100vh - 80px);
        background: white;
        z-index: 1000;
        box-shadow: 2px 0 8px rgba(0, 0, 0, 0.15);
        transition: left 0.3s ease;
        border-right: 2px solid #e0e0e0;
        padding: 0; /* ç§»é™¤ paddingï¼Œæ”¹ç‚ºå…§éƒ¨å…ƒç´ æ§åˆ¶ */
        overflow: hidden; /* æ”¹ç‚º hiddenï¼Œè®“å…§éƒ¨å…ƒç´ æ§åˆ¶æ»¾å‹• */
        flex: none;
        margin: 0;
        display: flex;
        flex-direction: column;
      }
      
      /* æ‰‹æ©Ÿç‰ˆå´é‚Šæ¬„å…§å®¹å€åŸŸå¸ƒå±€ */
      .quiz-sidebar .mobile-menu-header {
        padding: 15px 20px;
        flex-shrink: 0;
        border-bottom: 1px solid #e0e0e0;
      }
      
      .quiz-sidebar > div:not(.mobile-menu-header):not(#question-list) {
        padding: 15px 20px 0 20px;
        flex-shrink: 0;
      }
      
      .quiz-sidebar #question-list {
        flex: 1;
        overflow-y: auto;
        overflow-x: hidden;
        min-height: 0;
        padding: 15px 20px; /* å·¦å³å’Œä¸Šä¸‹æ·»åŠ  paddingï¼Œèˆ‡ç·´ç¿’ç›®éŒ„ä¸€è‡´ */
        max-height: none !important; /* ç§»é™¤æœ€å¤§é«˜åº¦é™åˆ¶ï¼Œå……åˆ†åˆ©ç”¨ç©ºé–“ */
      }
      
      .quiz-sidebar.menu-open {
        left: 0 !important; /* æ‰“é–‹æ™‚é¡¯ç¤º */
      }
      
      /* ç¢ºä¿ menu-open ç‹€æ…‹ä¸‹é¡Œç›®åˆ—è¡¨æ­£ç¢ºé¡¯ç¤º */
      .quiz-sidebar.menu-open #question-list {
        flex: 1 !important;
        min-height: 0 !important;
        overflow-y: auto !important;
        display: flex !important;
        flex-direction: column !important;
      }
      
      .quiz-layout {
        flex-direction: row; /* ä¿æŒæ©«å‘å¸ƒå±€ */
        padding: 15px;
      }
      
      .quiz-main {
        padding-left: 15px;
        padding-right: 15px;
        width: 100%;
      }
    }

    @media (max-width: 480px) {
      .practice-select-layout {
        padding: 10px;
      }

      .practice-sidebar {
        flex: 0 0 auto;
        min-width: 100%;
      }
    }

    /* æ¸¬é©—ç•«é¢å¸ƒå±€ */
    .quiz-layout {
      display: flex;
      gap: 20px;
      height: 100%;
      min-height: 100%;
      padding: 20px;
      width: 100%;
      max-width: 100%;
      box-sizing: border-box;
      margin: 0;
      overflow: hidden;
    }

    /* ç¢ºä¿æ¸¬é©—ç•«é¢å……åˆ†åˆ©ç”¨å¯¬åº¦ */
    #quiz-screen .quiz-layout {
      width: 100% !important;
      max-width: 100% !important;
    }

    /* æ¡Œé¢ç‰ˆæ¸¬é©—å´é‚Šæ¬„æ¨£å¼ */
    @media (min-width: 769px) {
      .quiz-sidebar {
        flex: 0 0 280px;
        min-width: 250px;
        max-width: 320px;
        border-right: 2px solid #e0e0e0;
        padding-right: 20px;
        overflow-y: auto;
        height: 100%;
        flex-shrink: 0;
      }
    }

    .quiz-main {
      flex: 1;
      min-width: 0;
      overflow-y: auto;
      overflow-x: hidden;
      padding-left: 20px;
      padding-bottom: 20px; /* é©ç•¶çš„åº•éƒ¨é–“è· */
      height: 100%;
      width: 100%;
      max-width: 100%;
      box-sizing: border-box;
      /* ç¢ºä¿å…§å®¹å€åŸŸå……åˆ†åˆ©ç”¨å¯¬åº¦ */
      display: flex;
      flex-direction: column;
    }

    /* ç¢ºä¿é¸é …å€åŸŸå’Œåé¥‹å€åŸŸæœ‰è¶³å¤ ç©ºé–“ï¼Œä¸è¢«å£“ç¸® */
    #options-container {
      flex-shrink: 0;
      margin-bottom: 10px;
    }

    /* ç¢ºä¿åé¥‹å€åŸŸæœ‰è¶³å¤ ç©ºé–“é¡¯ç¤ºï¼Œä¸è¢«æŒ‰éˆ•å£“ç¸® */
    #feedback-area {
      flex-shrink: 0 !important;
      margin: 20px 0 !important;
    }

    /* æ¸¬é©—å…§å®¹å€åŸŸçš„æœ€å¤§å¯¬åº¦é™åˆ¶ï¼ˆå¯é¸ï¼Œå¦‚æœéœ€è¦å¯ä»¥èª¿æ•´ï¼‰ */
    .quiz-main > * {
      max-width: 100%;
    }

    /* ç¢ºä¿é¸é …å€åŸŸå’Œåé¥‹å€åŸŸæœ‰è¶³å¤ ç©ºé–“ï¼Œä¸è¢«å£“ç¸® */
    #options-container {
      flex-shrink: 0;
      margin-bottom: 10px;
    }

    /* ç¢ºä¿åé¥‹å€åŸŸæœ‰è¶³å¤ ç©ºé–“é¡¯ç¤ºï¼Œä¸è¢«æŒ‰éˆ•å£“ç¸® */
    #feedback-area {
      flex-shrink: 0 !important;
      margin: 20px 0 !important;
    }

    /* é¡Œç›®ç›®éŒ„æ¨£å¼ */
    #question-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .question-item {
      padding: 10px 12px;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
      border: 2px solid transparent;
      background-color: #f8f9fa;
    }

    .question-item:hover {
      background-color: #e9ecef;
      border-color: #dee2e6;
    }

    .question-item.current {
      background-color: #eff6ff;
      border-color: var(--ion-color-primary);
      font-weight: 600;
      color: var(--ion-color-primary);
    }

    .question-item.answered {
      background-color: #f0fdf4;
      border-color: #86efac;
    }

    .question-item.answered.wrong {
      background-color: #fef2f2;
      border-color: #fca5a5;
    }

    .question-item-number {
      font-weight: 600;
      margin-right: 8px;
      color: #666;
    }

    .question-item.current .question-item-number {
      color: var(--ion-color-primary);
    }

    /* éŸ¿æ‡‰å¼è¨­è¨ˆ - æ¸¬é©—ç•«é¢ï¼ˆæ‰‹æ©Ÿç‰ˆæ¨£å¼å·²åœ¨ä¸Šé¢çµ±ä¸€è™•ç†ï¼‰ */
    @media (max-width: 768px) {
      .quiz-layout {
        flex-direction: row; /* ä¿æŒæ©«å‘å¸ƒå±€ï¼Œå´é‚Šæ¬„æœƒä»¥å›ºå®šå®šä½é¡¯ç¤º */
        padding: 15px;
      }

      .quiz-main {
        padding-left: 15px;
        padding-right: 15px;
        width: 100%;
      }
    }

    /* ç‰ˆæ¬Šè³‡è¨Šæ¨£å¼ */
    .copyright-footer {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background-color: rgba(255, 255, 255, 0.95);
      border-top: 1px solid #e0e0e0;
      padding: 10px 20px;
      text-align: center;
      font-size: 0.75em;
      color: #666;
      z-index: 1000;
      box-shadow: 0 -2px 4px rgba(0, 0, 0, 0.05);
    }

    .copyright-footer p {
      margin: 4px 0;
      line-height: 1.4;
    }

    /* ç¢ºä¿å…§å®¹ä¸è¢«ç‰ˆæ¬Šè³‡è¨Šé®æ“‹ */
    .quiz-container {
      padding-bottom: 80px;
      min-height: calc(100vh - 80px);
    }

    #practice-select-screen {
      padding-bottom: 0; /* ä¸éœ€è¦é¡å¤– paddingï¼Œé«˜åº¦å·²åœ¨ä¸Šé¢è¨ˆç®— */
      min-height: calc(100vh - 80px);
      max-height: calc(100vh - 80px);
    }

    #result-screen,
    #name-input-screen,
    #password-setup-screen,
    #loading-screen,
    #error-screen {
      padding-bottom: 80px;
      min-height: calc(100vh - 80px);
    }
    
    /* ç™»å…¥é é¢ç‰¹æ®Šè™•ç†ï¼Œç¢ºä¿éŒ¯èª¤ä¿¡æ¯ä¸è¢«ç‰ˆæ¬Šä¿¡æ¯è¦†è“‹ */
    #password-login-screen {
      padding-bottom: 120px !important;
      min-height: calc(100vh - 80px) !important;
    }
    
    #password-login-screen .password-container {
      margin-bottom: 100px;
      padding-bottom: 20px;
    }
    
    #login-error {
      min-height: 2em;
      padding-bottom: 15px;
      margin-bottom: 20px;
      word-wrap: break-word;
      overflow-wrap: break-word;
      line-height: 1.5;
    }

    /* ç·´ç¿’é¸æ“‡ç•«é¢å¸ƒå±€å·²åœ¨ä¸Šé¢çš„ .practice-select-layout ä¸­è™•ç†é«˜åº¦ï¼Œä¸éœ€è¦é¡å¤– padding */

    /* æ¸¬é©—ç•«é¢å¸ƒå±€èª¿æ•´ */
    #quiz-screen .quiz-layout {
      height: 100% !important;
      padding-bottom: 20px;
      overflow-y: auto; /* å…è¨±å‚ç›´æ»¾å‹• */
    }
    
    /* ç¢ºä¿æ¸¬é©—ç•«é¢å…§å®¹å¯ä»¥æ­£å¸¸é¡¯ç¤º */
    #quiz-screen .quiz-main {
      overflow-y: auto;
      overflow-x: hidden;
    }
  </style>
</head>

<body>
  <ion-app>
    <ion-content class="ion-padding">
      <div class="quiz-container">

        <!-- 1. å¯†ç¢¼è¨­ç½®ç•«é¢ -->
        <div id="password-setup-screen" class="hidden">
          <div class="password-container" style="margin-top: 30%;">
            <ion-card>
              <ion-card-header>
                <ion-card-title class="ion-text-center">
                  <ion-icon name="lock-closed" style="font-size: 48px; color: var(--ion-color-primary);"></ion-icon>
                  <h2>è¨­ç½®å¯†ç¢¼</h2>
                </ion-card-title>
              </ion-card-header>
              <ion-card-content>
                <ion-item>
                  <ion-label position="stacked">è«‹è¼¸å…¥æ–°å¯†ç¢¼</ion-label>
                  <ion-input id="setup-password-input" type="password" placeholder="å¯†ç¢¼"></ion-input>
                </ion-item>
                <ion-item>
                  <ion-label position="stacked">ç¢ºèªå¯†ç¢¼</ion-label>
                  <ion-input id="setup-confirm-input" type="password" placeholder="å†æ¬¡è¼¸å…¥å¯†ç¢¼"></ion-input>
                </ion-item>
                <ion-button expand="block" size="large" class="ion-margin-top" onclick="setupPassword()">
                  è¨­ç½®å¯†ç¢¼
                </ion-button>
                <p id="setup-error" style="color: var(--ion-color-danger); text-align: center; margin-top: 10px; font-size: 0.9em;"></p>
              </ion-card-content>
            </ion-card>
          </div>
        </div>

        <!-- 2. å¯†ç¢¼ç™»å…¥ç•«é¢ -->
        <div id="password-login-screen" class="hidden">
          <div class="password-container" style="margin-top: 15%; margin-bottom: 100px; padding-bottom: 20px;">
            <ion-card>
              <ion-card-header>
                <ion-card-title class="ion-text-center">
                  <ion-icon name="lock-closed" style="font-size: 48px; color: var(--ion-color-primary);"></ion-icon>
                  <h2>ç·šä¸Šå­¸ç¿’å¹³å°</h2>
                </ion-card-title>
              </ion-card-header>
              <ion-card-content>
                <ion-item>
                  <ion-label position="stacked">èª²ç¨‹ç·¨è™Ÿ</ion-label>
                  <ion-input id="login-course-code-input" type="text" placeholder="è«‹è¼¸å…¥èª²ç¨‹ç·¨è™Ÿ" autocomplete="off"></ion-input>
                </ion-item>
                <ion-item>
                  <ion-label position="stacked">å¯†ç¢¼</ion-label>
                  <ion-input id="login-password-input" type="password" placeholder="è«‹è¼¸å…¥å¯†ç¢¼"></ion-input>
                </ion-item>
                <ion-button expand="block" size="large" class="ion-margin-top" onclick="login()">
                  ç™»å…¥
                </ion-button>
                <p style="text-align: center; margin-top: 10px; font-size: 0.85em; color: #666;">
                  è«‹å‘è€å¸«ç´¢å–èª²ç¨‹ç·¨è™Ÿå’Œå¯†ç¢¼
                </p>
                <p id="login-error" style="color: var(--ion-color-danger); text-align: center; margin-top: 10px; margin-bottom: 20px; font-size: 0.9em; min-height: 1.5em; padding-bottom: 10px;"></p>
              </ion-card-content>
            </ion-card>
          </div>
        </div>

        <!-- 3. ç·´ç¿’é¸æ“‡ç•«é¢ -->
        <div id="practice-select-screen" class="hidden">
          <!-- æ‰‹æ©Ÿç‰ˆèœå–®æŒ‰éˆ• -->
          <div class="mobile-menu-toggle" onclick="togglePracticeMenu()">
            <ion-button fill="clear" size="default">
              <ion-icon slot="icon-only" name="menu"></ion-icon>
            </ion-button>
          </div>
          
          <!-- å´é‚Šèœå–®é®ç½©ï¼ˆæ‰‹æ©Ÿç‰ˆï¼‰ -->
          <div id="practice-menu-overlay" class="menu-overlay" onclick="closePracticeMenu()"></div>
          
          <div class="practice-select-layout">
            <!-- å·¦å´ï¼šç·´ç¿’ç›®éŒ„ -->
            <div class="practice-sidebar" id="practice-sidebar">
              <div class="mobile-menu-header">
                <h2 style="margin: 0; font-size: 1.3em; flex: 1;">ç·´ç¿’ç›®éŒ„</h2>
                <ion-button fill="clear" size="small" onclick="closePracticeMenu()" class="mobile-menu-close">
                  <ion-icon slot="icon-only" name="close"></ion-icon>
                </ion-button>
              </div>
              <div class="ion-text-center" style="margin-bottom: 15px;">
                <ion-badge color="primary" style="font-size: 0.9em; padding: 6px 12px;">
                  èª²ç¨‹ç·¨è™Ÿ: <span id="current-course-code-display">-</span>
                </ion-badge>
              </div>
              <div id="practice-list">
                <!-- ç·´ç¿’é¸é …æœƒç”± JS å‹•æ…‹ç”¢ç”Ÿ -->
              </div>
              
              <ion-button expand="block" fill="clear" size="small" class="ion-margin-top" onclick="logout()">
                <ion-icon slot="start" name="log-out"></ion-icon>
                ç™»å‡º
              </ion-button>
            </div>

            <!-- å³å´ï¼šæ’è¡Œæ¦œä¸»é  -->
            <div class="leaderboard-main">
              <h2 style="margin-bottom: 20px; font-size: 1.5em;">å¾—åˆ†æ’è¡Œæ¦œ</h2>
              <div id="leaderboard-container">
                <!-- æ’è¡Œæ¦œæœƒç”± JS å‹•æ…‹ç”¢ç”Ÿ -->
              </div>
            </div>
          </div>
        </div>

        <!-- 3.5. å§“åè¼¸å…¥ç•«é¢ -->
        <div id="name-input-screen" class="hidden">
          <div class="password-container" style="margin-top: 30%;">
            <ion-card>
              <ion-card-header>
                <ion-card-title class="ion-text-center">
                  <ion-icon name="person" style="font-size: 48px; color: var(--ion-color-primary);"></ion-icon>
                  <h2>è«‹è¼¸å…¥æ‚¨çš„å§“å</h2>
                </ion-card-title>
              </ion-card-header>
              <ion-card-content>
                <ion-item>
                  <ion-label position="stacked">å§“å</ion-label>
                  <ion-input id="student-name-input" type="text" placeholder="è«‹è¼¸å…¥æ‚¨çš„å§“å" autocomplete="off"></ion-input>
                </ion-item>
                <p style="text-align: center; margin-top: 10px; font-size: 0.85em; color: #666;">
                  æ­¤å§“åå°‡ç”¨æ–¼è¨˜éŒ„æ‚¨çš„å¾—åˆ†
                </p>
                <ion-button expand="block" size="large" class="ion-margin-top" onclick="startPracticeWithName()">
                  é–‹å§‹ç·´ç¿’
                </ion-button>
                <ion-button expand="block" fill="outline" size="small" class="ion-margin-top" onclick="backToPracticeSelect()">
                  è¿”å›ç·´ç¿’é¸æ“‡
                </ion-button>
                <p id="name-input-error" style="color: var(--ion-color-danger); text-align: center; margin-top: 10px; font-size: 0.9em;"></p>
              </ion-card-content>
            </ion-card>
          </div>
        </div>

        <!-- 4. è¼‰å…¥ç•«é¢ -->
        <div id="loading-screen" class="ion-text-center" style="margin-top: 50%;">
          <ion-spinner name="crescent" color="primary" style="transform: scale(1.5);"></ion-spinner>
          <p class="ion-margin-top text-gray-500">æ­£åœ¨è¼‰å…¥é¡Œåº«...</p>
        </div>

        <!-- 5. éŒ¯èª¤ç•«é¢ -->
        <div id="error-screen" class="hidden ion-text-center" style="margin-top: 40%;">
          <ion-icon name="warning-outline" color="danger" style="font-size: 64px;"></ion-icon>
          <h2>ç™¼ç”ŸéŒ¯èª¤</h2>
          <p id="error-message">ç„¡æ³•è®€å–è³‡æ–™</p>
          <ion-button expand="block" onclick="location.reload()">é‡æ–°æ•´ç†</ion-button>
        </div>

        <!-- 3. æ¸¬é©—ä¸»ç•«é¢ -->
        <div id="quiz-screen" class="hidden">
          <!-- æ‰‹æ©Ÿç‰ˆèœå–®æŒ‰éˆ• -->
          <div class="mobile-menu-toggle" onclick="toggleQuizMenu()">
            <ion-button fill="clear" size="default">
              <ion-icon slot="icon-only" name="menu"></ion-icon>
            </ion-button>
          </div>
          
          <!-- å´é‚Šèœå–®é®ç½©ï¼ˆæ‰‹æ©Ÿç‰ˆï¼‰ -->
          <div id="quiz-menu-overlay" class="menu-overlay" onclick="closeQuizMenu()"></div>
          
          <div class="quiz-layout">
            <!-- å·¦å´ï¼šé¡Œç›®ç›®éŒ„ -->
            <div class="quiz-sidebar" id="quiz-sidebar">
              <div class="mobile-menu-header">
                <h3 style="margin: 0; font-size: 1.1em; font-weight: 600; color: #1f2937; flex: 1;">é¡Œç›®ç›®éŒ„</h3>
                <ion-button fill="clear" size="small" onclick="closeQuizMenu()" class="mobile-menu-close">
                  <ion-icon slot="icon-only" name="close"></ion-icon>
                </ion-button>
              </div>
              <div style="margin-bottom: 15px; flex-shrink: 0;">
                <ion-button size="small" fill="outline" expand="block" onclick="backToPracticeSelectFromQuiz()">
                  <ion-icon slot="start" name="arrow-back"></ion-icon>
                  è¿”å›ç·´ç¿’ç›®éŒ„
                </ion-button>
              </div>
              <div id="question-list">
                <!-- é¡Œç›®åˆ—è¡¨æœƒç”± JS å‹•æ…‹ç”¢ç”Ÿ -->
              </div>
            </div>

            <!-- å³å´ï¼šæ¸¬é©—å…§å®¹ -->
            <div class="quiz-main">
              <!-- ç·´ç¿’åç¨± -->
              <div style="margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #e0e0e0;">
                <h2 id="practice-name-display" style="margin: 0; font-size: 1.5em; font-weight: 600; color: #1f2937;">
                  ç·´ç¿’è¼‰å…¥ä¸­...
                </h2>
              </div>

              <!-- é€²åº¦æ¢èˆ‡æ¨™é¡Œ -->
              <div class="ion-margin-bottom">
                <div style="display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 8px;">
                  <span style="color: #666; font-size: 0.9em;">Question <span id="q-current">1</span> / <span id="q-total">10</span></span>
                  <ion-badge color="primary">ç·´ç¿’ä¸­</ion-badge>
                </div>
                <ion-progress-bar id="progress-bar" value="0"></ion-progress-bar>
              </div>

              <!-- é¡Œç›®å¡ç‰‡ -->
              <ion-card class="protected-content" style="margin: 0; box-shadow: none; background: transparent; flex-shrink: 0;">
                <h2 id="question-text" class="protected-content" style="font-weight: bold; font-size: 1.25rem; color: #1f2937; margin-bottom: 20px; line-height: 1.6; word-wrap: break-word; overflow-wrap: break-word; white-space: normal; min-height: 2em; padding: 10px 0;">
                  é¡Œç›®è¼‰å…¥ä¸­...
                </h2>
              </ion-card>

              <!-- é¸é …å€åŸŸ -->
              <div id="options-container" class="protected-content">
                <!-- é¸é …æœƒç”± JS å‹•æ…‹ç”¢ç”Ÿ -->
              </div>

              <!-- è§£æ/å›é¥‹å€åŸŸ -->
              <ion-card id="feedback-area" class="hidden protected-content" style="margin: 20px 0 0 0; border-left: 4px solid;">
                <ion-card-content>
                  <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                    <ion-icon id="feedback-icon" style="font-size: 20px;"></ion-icon>
                    <strong id="feedback-title" style="font-size: 1.1em;"></strong>
                  </div>
                  <p id="feedback-text" style="color: #4b5563; line-height: 1.5;"></p>
                </ion-card-content>
              </ion-card>

              <!-- åº•éƒ¨æŒ‰éˆ• -->
              <div style="margin-top: 30px; flex-shrink: 0;">
                <ion-button id="submit-btn" expand="block" size="large" disabled="true">æäº¤ç­”æ¡ˆ</ion-button>
                <ion-button id="next-btn" expand="block" size="large" color="dark" class="hidden">
                  ä¸‹ä¸€é¡Œ <ion-icon slot="end" name="arrow-forward"></ion-icon>
                </ion-button>
              </div>
            </div>
          </div>
        </div>

        <!-- 4. çµæœç•«é¢ -->
        <div id="result-screen" class="hidden ion-text-center">
          <!-- é ‚éƒ¨è¿”å›æŒ‰éˆ• -->
          <div style="margin-bottom: 20px; text-align: left;">
            <ion-button fill="outline" size="default" onclick="backToPracticeSelect()">
              <ion-icon slot="start" name="arrow-back"></ion-icon>
              è¿”å›ç·´ç¿’ç›®éŒ„
            </ion-button>
          </div>
          
          <ion-card class="protected-content">
            <ion-card-content class="ion-padding-vertical protected-content">
              <p id="student-name-display" class="protected-content" style="font-size: 1.1em; color: #666; margin-bottom: 10px;"></p>
              <ion-icon id="result-icon" style="font-size: 80px; margin-bottom: 10px;"></ion-icon>
              <h1 id="final-score" class="protected-content" style="font-size: 3rem; font-weight: bold; margin: 0;">0</h1>
              <p class="protected-content">åˆ†</p>
              <p id="result-msg" class="protected-content" style="font-size: 1.2rem; margin-top: 10px;"></p>
            </ion-card-content>
          </ion-card>

          <div class="ion-text-left ion-margin-top protected-content">
            <h3 class="protected-content">ç­”é¡Œç´€éŒ„</h3>
            <ion-list id="history-list" class="protected-content" lines="full">
              <!-- æ­·å²ç´€éŒ„ç”± JS ç”¢ç”Ÿ -->
            </ion-list>
          </div>

          <ion-button expand="block" size="large" class="ion-margin-top" onclick="restartQuiz()">
            <ion-icon slot="start" name="refresh"></ion-icon>
            é‡æ–°æŒ‘æˆ°
          </ion-button>
          <ion-button expand="block" fill="outline" size="large" class="ion-margin-top" onclick="backToPracticeSelect()">
            <ion-icon slot="start" name="list"></ion-icon>
            è¿”å›ç·´ç¿’ç›®éŒ„
          </ion-button>
        </div>

      </div>
    </ion-content>
    
    <!-- ç‰ˆæ¬Šè³‡è¨Š -->
    <div class="copyright-footer">
      <p>&copy; <span id="copyright-year">2024</span> ç·šä¸Šå­¸ç¿’å¹³å°. Jacky Sir ç‰ˆæ¬Šæ‰€æœ‰.</p>
      <p>åƒ…ä¾› Jacky Sir æˆæ¬Šå­¸ç”Ÿä½¿ç”¨ï¼Œæœªç¶“è¨±å¯ä¸å¾—è¤‡è£½æˆ–åˆ†äº«</p>
    </div>
  </ion-app>

  <script>
    // ==========================================
    // å®‰å…¨ä¿è­·åŠŸèƒ½ï¼ˆé˜²æ­¢éæˆæ¬Šè¨ªå•å’Œå…§å®¹æ´©éœ²ï¼‰
    // ==========================================
    
    // HTML è½‰ç¾©å‡½æ•¸ï¼ˆé˜²æ­¢ XSS æ”»æ“Šï¼‰
    function escapeHtml(text) {
      if (typeof text !== 'string') {
        text = String(text || '');
      }
      const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
      };
      return text.replace(/[&<>"']/g, m => map[m]);
    }
    
    // æ¸…ç†ç”¨æˆ¶è¼¸å…¥ï¼ˆç§»é™¤å±éšªå­—ç¬¦ï¼‰
    function sanitizeInput(input) {
      if (typeof input !== 'string') {
        return '';
      }
      // ç§»é™¤ HTML æ¨™ç±¤å’Œå±éšªå­—ç¬¦
      return input
        .replace(/<[^>]*>/g, '') // ç§»é™¤ HTML æ¨™ç±¤
        .replace(/[<>\"']/g, '') // ç§»é™¤å±éšªå­—ç¬¦
        .trim()
        .substring(0, 200); // é™åˆ¶é•·åº¦
    }
    
    // 1. é˜²æ­¢å³éµèœå–®
    document.addEventListener('contextmenu', function(e) {
      e.preventDefault();
      return false;
    });

    // 2. é˜²æ­¢å¸¸è¦‹çš„é–‹ç™¼è€…å·¥å…·å¿«æ·éµ
    document.addEventListener('keydown', function(e) {
      // é˜²æ­¢ F12
      if (e.key === 'F12') {
        e.preventDefault();
        return false;
      }
      // é˜²æ­¢ Ctrl+Shift+I (é–‹ç™¼è€…å·¥å…·)
      if (e.ctrlKey && e.shiftKey && e.key === 'I') {
        e.preventDefault();
        return false;
      }
      // é˜²æ­¢ Ctrl+Shift+J (æ§åˆ¶å°)
      if (e.ctrlKey && e.shiftKey && e.key === 'J') {
        e.preventDefault();
        return false;
      }
      // é˜²æ­¢ Ctrl+U (æŸ¥çœ‹æºä»£ç¢¼)
      if (e.ctrlKey && e.key === 'u') {
        e.preventDefault();
        return false;
      }
      // é˜²æ­¢ Ctrl+S (ä¿å­˜ç¶²é )
      if (e.ctrlKey && e.key === 's') {
        e.preventDefault();
        return false;
      }
      // é˜²æ­¢ Ctrl+P (æ‰“å°)
      if (e.ctrlKey && e.key === 'p') {
        e.preventDefault();
        return false;
      }
      // é˜²æ­¢ Ctrl+Shift+C (æª¢æŸ¥å…ƒç´ )
      if (e.ctrlKey && e.shiftKey && e.key === 'C') {
        e.preventDefault();
        return false;
      }
    });

    // 3. æª¢æ¸¬é–‹ç™¼è€…å·¥å…·ï¼ˆå®šæœŸæª¢æŸ¥ï¼‰
    let devtools = {open: false, orientation: null};
    const threshold = 160;
    setInterval(function() {
      if (window.outerHeight - window.innerHeight > threshold || 
          window.outerWidth - window.innerWidth > threshold) {
        if (!devtools.open) {
          devtools.open = true;
          // è¨˜éŒ„é–‹ç™¼è€…å·¥å…·æª¢æ¸¬
          logAccess('devtools_detected', false, 'æª¢æ¸¬åˆ°é–‹ç™¼è€…å·¥å…·é–‹å•Ÿ');
          // å¯ä»¥é¸æ“‡ï¼šè­¦å‘Šã€æ¸…é™¤å…§å®¹ã€æˆ–è¨˜éŒ„
          console.clear();
          console.log('%cè­¦å‘Šï¼', 'color: red; font-size: 50px; font-weight: bold;');
          console.log('%cæœªç¶“æˆæ¬Šçš„è¨ªå•å˜—è©¦å·²è¢«è¨˜éŒ„ã€‚', 'color: red; font-size: 20px;');
          // å¯é¸ï¼šæ¸…é™¤æ•æ„Ÿå…§å®¹
          // document.body.innerHTML = '<h1>æœªç¶“æˆæ¬Šçš„è¨ªå•</h1>';
        }
      } else {
        devtools.open = false;
      }
    }, 500);

    // 4. é˜²æ­¢æ–‡æœ¬é¸æ“‡å’Œè¤‡è£½ï¼ˆåƒ…åœ¨æ¸¬é©—ç•«é¢å•Ÿç”¨ï¼‰
    function enableContentProtection() {
      document.body.classList.add('no-select');
      document.body.classList.add('protected-content');
      
      // é˜²æ­¢è¤‡è£½
      document.addEventListener('copy', function(e) {
        e.clipboardData.setData('text/plain', '');
        e.preventDefault();
        return false;
      });
      
      // é˜²æ­¢æ‹–æ‹½
      document.addEventListener('dragstart', function(e) {
        e.preventDefault();
        return false;
      });
    }

    function disableContentProtection() {
      document.body.classList.remove('no-select');
      document.body.classList.remove('protected-content');
    }

    // 5. æ·»åŠ æ°´å°ï¼ˆåœ¨æ¸¬é©—å’Œçµæœç•«é¢é¡¯ç¤ºï¼‰
    function addWatermark(text = 'åƒ…ä¾›æˆæ¬Šå­¸ç”Ÿä½¿ç”¨') {
      // ç§»é™¤èˆŠæ°´å°
      const oldWatermark = document.getElementById('content-watermark');
      if (oldWatermark) {
        oldWatermark.remove();
      }
      
      const watermark = document.createElement('div');
      watermark.id = 'content-watermark';
      watermark.className = 'watermark';
      watermark.textContent = text;
      document.body.appendChild(watermark);
    }

    function removeWatermark() {
      const watermark = document.getElementById('content-watermark');
      if (watermark) {
        watermark.remove();
      }
    }

    // 6. é˜²æ­¢èª¿è©¦ï¼ˆæª¢æ¸¬èª¿è©¦å™¨ï¼‰
    (function() {
      function detectDevTools() {
        const start = performance.now();
        debugger;
        const end = performance.now();
        if (end - start > 100) {
          // æª¢æ¸¬åˆ°èª¿è©¦å™¨
          console.clear();
          console.log('%cæª¢æ¸¬åˆ°èª¿è©¦å·¥å…·', 'color: red; font-size: 30px;');
        }
      }
      // å®šæœŸæª¢æ¸¬ï¼ˆé »ç‡è¼ƒä½ï¼Œé¿å…å½±éŸ¿æ€§èƒ½ï¼‰
      setInterval(detectDevTools, 3000);
    })();

    // 7. é˜²æ­¢æˆªåœ–ï¼ˆé€šéæ·»åŠ æ°´å°å’Œç¦ç”¨æŸäº›åŠŸèƒ½ï¼‰
    // æ³¨æ„ï¼šå®Œå…¨é˜²æ­¢æˆªåœ–åœ¨å‰ç«¯æ˜¯ä¸å¯èƒ½çš„ï¼Œä½†å¯ä»¥å¢åŠ é›£åº¦

    // ==========================================
    // è¨­å®šå€ï¼ˆè€å¸«è«‹ä¿®æ”¹ä»¥ä¸‹é…ç½®ï¼‰
    // ==========================================
    
    // âš ï¸ é‡è¦ï¼šè«‹ä¿®æ”¹æ­¤å¯†ç¢¼ç‚ºæ‚¨è¦çµ¦å­¸ç”Ÿçš„å¯†ç¢¼
    // 
    // ä½¿ç”¨èªªæ˜ï¼š
    // 1. å°‡ 'teacher123' æ›¿æ›ç‚ºæ‚¨æƒ³è¦çš„å¯†ç¢¼
    // 2. å¯†ç¢¼æœƒç¶“éå“ˆå¸Œè™•ç†å¾Œèˆ‡å­¸ç”Ÿè¼¸å…¥çš„å¯†ç¢¼æ¯”è¼ƒ
    // 3. å»ºè­°ä½¿ç”¨è¼ƒè¤‡é›œçš„å¯†ç¢¼ï¼ˆè‡³å°‘8å€‹å­—ç¬¦ï¼ŒåŒ…å«å­—æ¯å’Œæ•¸å­—ï¼‰
    // 4. ä¿®æ”¹å¯†ç¢¼å¾Œï¼Œå°‡æ­¤æ–‡ä»¶ä¿å­˜ä¸¦éƒ¨ç½²
    // 5. å­¸ç”Ÿç„¡æ³•è‡ªè¡Œè¨­ç½®æˆ–ä¿®æ”¹å¯†ç¢¼ï¼Œåªèƒ½è¼¸å…¥æ‚¨è¨­å®šçš„å¯†ç¢¼
    // 6. ç™»å…¥ç‹€æ…‹ä½¿ç”¨ sessionStorageï¼Œé—œé–‰ç€è¦½å™¨å¾Œæœƒè‡ªå‹•ç™»å‡º
    //
    // âš ï¸ Google Spreadsheet é…ç½®
    // è«‹è¨­ç½®æ‚¨çš„ Google Apps Script Web App URL
    // è¨­ç½®æ­¥é©Ÿè«‹åƒè€ƒæ–‡ä»¶åº•éƒ¨çš„èªªæ˜
    // 
    // é‡è¦å®‰å…¨èªªæ˜ï¼š
    // - æ‰€æœ‰èª²ç¨‹å¯†ç¢¼å’Œæœ‰æ•ˆæœŸéƒ½å­˜å„²åœ¨ Google Spreadsheet çš„ "Courses" è¡¨ä¸­
    // - æ‰€æœ‰ç·´ç¿’æ¸…å–®éƒ½å­˜å„²åœ¨ Google Spreadsheet çš„ "Practices" è¡¨ä¸­
    // - å­¸ç”Ÿç„¡æ³•ç›´æ¥è¨ªå• Spreadsheetï¼Œæ‰€æœ‰æ•¸æ“šéƒ½é€šé Google Apps Script é©—è­‰å¾Œè¿”å›
    // - é€™æ¨£å¯ä»¥é˜²æ­¢å­¸ç”Ÿé€šéé€†å‘å·¥ç¨‹æ‰¾åˆ° Spreadsheet URL ä¸¦æŸ¥çœ‹æ‰€æœ‰é¡Œç›®
    const GOOGLE_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxgoSW5D-r_PIk0oo7BqSK9OOD4nTj6b81rNcdmBzJnqFcUBvcXl7LbUDzvPvs8N4aypQ/exec'; // ğŸ‘ˆ è«‹å¡«å…¥æ‚¨çš„ Google Apps Script Web App URL
    
    // ç·´ç¿’é…ç½®åˆ—è¡¨ï¼ˆé»˜èªåˆ—è¡¨ï¼Œå¯¦éš›ä½¿ç”¨æ™‚æœƒåœ¨ç™»å…¥æ™‚å¾ Google Spreadsheet åŠ è¼‰ï¼‰
    let PRACTICES = [
      {
        id: 'practice1',
        name: 'Ionic åŸºç¤æ¸¬é©—',
        description: 'æ¸¬è©¦ä½ å° Ionic æ¡†æ¶çš„åŸºæœ¬ç†è§£',
        csvUrl: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vR6y2w2J2tO_k-X8tXQy3z5oP5o5z5o5z5o5z5o/pub?output=csv',
        passingScore: 80,
        courseCode: 'CS101'
      },
      {
        id: 'practice2',
        name: 'JavaScript é€²éšæ¸¬é©—',
        description: 'é€²éš JavaScript æ¦‚å¿µèˆ‡æ‡‰ç”¨',
        csvUrl: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vR6y2w2J2tO_k-X8tXQy3z5oP5o5z5o5z5o5z5o/pub?output=csv',
        passingScore: 75,
        courseCode: 'CS101'
      },
      {
        id: 'practice3',
        name: 'Web é–‹ç™¼ç¶œåˆæ¸¬é©—',
        description: 'æ¶µè“‹ HTMLã€CSSã€JavaScript çš„ç¶œåˆæ¸¬é©—',
        csvUrl: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vR6y2w2J2tO_k-X8tXQy3z5oP5o5z5o5z5o5z5o/pub?output=csv',
        passingScore: 70,
        courseCode: 'CS102'
      }
    ];

    // å­˜å„²éµåï¼ˆä½¿ç”¨ sessionStorageï¼Œé—œé–‰ç€è¦½å™¨å¾Œå¤±æ•ˆï¼‰
    const LOGIN_SESSION_KEY = 'quiz_app_logged_in';
    const COURSE_CODE_KEY = 'quiz_app_course_code'; // ç•¶å‰ç™»å…¥çš„èª²ç¨‹ç·¨è™Ÿ
    const PRACTICES_STORAGE_KEY = 'quiz_app_practices'; // ç·´ç¿’æ¸…å–®ï¼ˆèˆ‡èª²ç¨‹ç·¨è™Ÿç¶å®šï¼‰
    const ACCESS_LOG_KEY = 'quiz_app_access_log';
    const SCORES_STORAGE_KEY = 'quiz_app_scores'; // å­¸ç”Ÿå¾—åˆ†è¨˜éŒ„
    const PRACTICE_PROGRESS_KEY = 'quiz_app_practice_progress'; // ç·´ç¿’é€²åº¦ï¼ˆæŒä¹…åŒ–ä¿å­˜ï¼‰
    const MAX_LOG_ENTRIES = 50; // æœ€å¤šä¿å­˜50æ¢è¨˜éŒ„

    // ==========================================
    // è®Šæ•¸åˆå§‹åŒ–
    // ==========================================
    let questions = [];
    let currentQIndex = 0;
    let score = 0;
    let selectedOptionIndex = null;
    let isAnswered = false;
    let historyData = [];
    let currentPractice = null; // ç•¶å‰é¸æ“‡çš„ç·´ç¿’
    let PASSING_SCORE = 80; // å‹•æ…‹è¨­ç½®
    let currentStudentName = ''; // ç•¶å‰å­¸ç”Ÿçš„å§“å

    // DOM å…ƒç´ 
    const passwordSetupScreen = document.getElementById('password-setup-screen');
    const passwordLoginScreen = document.getElementById('password-login-screen');
    const practiceSelectScreen = document.getElementById('practice-select-screen');
    const nameInputScreen = document.getElementById('name-input-screen');
    const loadingScreen = document.getElementById('loading-screen');
    const errorScreen = document.getElementById('error-screen');
    const quizScreen = document.getElementById('quiz-screen');
    const resultScreen = document.getElementById('result-screen');
    
    const qCurrentEl = document.getElementById('q-current');
    const qTotalEl = document.getElementById('q-total');
    const progressBar = document.getElementById('progress-bar');
    const questionText = document.getElementById('question-text');
    const optionsContainer = document.getElementById('options-container');
    const feedbackArea = document.getElementById('feedback-area');
    const feedbackTitle = document.getElementById('feedback-title');
    const feedbackText = document.getElementById('feedback-text');
    const feedbackIcon = document.getElementById('feedback-icon');
    
    const submitBtn = document.getElementById('submit-btn');
    const nextBtn = document.getElementById('next-btn');

    // ==========================================
    // é‚è¼¯å‡½å¼
    // ==========================================

    // 0. å¯†ç¢¼ç®¡ç†å‡½å¼ï¼ˆç¾åœ¨é€šé Google Apps Script é©—è­‰ï¼Œä¸å†ä½¿ç”¨æœ¬åœ°å¯†ç¢¼ï¼‰
    
    // æª¢æŸ¥æ˜¯å¦å·²ç™»å…¥ï¼ˆä½¿ç”¨ sessionStorageï¼Œé—œé–‰ç€è¦½å™¨å¾Œå¤±æ•ˆï¼‰
    function isLoggedIn() {
      return sessionStorage.getItem(LOGIN_SESSION_KEY) === 'true';
    }

    // ç²å–ç•¶å‰èª²ç¨‹ç·¨è™Ÿ
    function getCurrentCourseCode() {
      return sessionStorage.getItem(COURSE_CODE_KEY) || '';
    }

    // è¨­ç½®ç™»å…¥ç‹€æ…‹å’Œèª²ç¨‹ç·¨è™Ÿ
    function setLoggedIn(courseCode) {
      sessionStorage.setItem(LOGIN_SESSION_KEY, 'true');
      sessionStorage.setItem(COURSE_CODE_KEY, courseCode);
    }

    // ä¿å­˜ç·´ç¿’æ¸…å–®åˆ° sessionStorage
    function savePracticesToStorage(practices, courseCode) {
      try {
        const data = {
          courseCode: courseCode,
          practices: practices,
          timestamp: Date.now()
        };
        sessionStorage.setItem(PRACTICES_STORAGE_KEY, JSON.stringify(data));
        console.log('ç·´ç¿’æ¸…å–®å·²ä¿å­˜åˆ° sessionStorage');
      } catch (error) {
        console.error('ä¿å­˜ç·´ç¿’æ¸…å–®å¤±æ•—:', error);
      }
    }

    // å¾ sessionStorage æ¢å¾©ç·´ç¿’æ¸…å–®
    function loadPracticesFromStorage(courseCode) {
      try {
        const stored = sessionStorage.getItem(PRACTICES_STORAGE_KEY);
        if (!stored) {
          return null;
        }
        
        const data = JSON.parse(stored);
        
        // æª¢æŸ¥èª²ç¨‹ç·¨è™Ÿæ˜¯å¦åŒ¹é…
        if (data.courseCode === courseCode && data.practices && Array.isArray(data.practices)) {
          console.log('å¾ sessionStorage æ¢å¾©ç·´ç¿’æ¸…å–®ï¼Œå…±', data.practices.length, 'å€‹ç·´ç¿’');
          return data.practices;
        } else {
          // èª²ç¨‹ç·¨è™Ÿä¸åŒ¹é…ï¼Œæ¸…é™¤èˆŠæ•¸æ“š
          sessionStorage.removeItem(PRACTICES_STORAGE_KEY);
          return null;
        }
      } catch (error) {
        console.error('æ¢å¾©ç·´ç¿’æ¸…å–®å¤±æ•—:', error);
        sessionStorage.removeItem(PRACTICES_STORAGE_KEY);
        return null;
      }
    }

    // å¾æœå‹™å™¨ç²å–æœ€æ–°ç·´ç¿’æ¸…å–®ï¼ˆä¸éœ€è¦å¯†ç¢¼ï¼Œåªéœ€è¦èª²ç¨‹ç·¨è™Ÿï¼‰
    async function fetchPracticesFromServer(courseCode) {
      try {
        if (!GOOGLE_APPS_SCRIPT_URL) {
          throw new Error('æœªè¨­ç½®ä¼ºæœå™¨é€£æ¥');
        }

        // ç¢ºä¿ courseCode å­˜åœ¨ä¸”æœ‰æ•ˆ
        if (!courseCode || courseCode.trim() === '') {
          throw new Error('èª²ç¨‹ç·¨è™Ÿä¸èƒ½ç‚ºç©º');
        }

        const urlParams = new URLSearchParams();
        urlParams.append('action', 'getPractices');
        urlParams.append('courseCode', courseCode.trim().toUpperCase());
        
        const requestUrl = `${GOOGLE_APPS_SCRIPT_URL}?${urlParams.toString()}`;
        
        console.log('è«‹æ±‚ç·´ç¿’æ¸…å–® URL:', requestUrl);
        console.log('åƒæ•¸:', { action: 'getPractices', courseCode: courseCode.trim().toUpperCase() });

        const response = await fetch(requestUrl, {
          method: 'GET',
          mode: 'cors',
          cache: 'no-cache'
        });

        if (!response.ok) {
          throw new Error(`ç„¡æ³•é€£æ¥åˆ°æœå‹™å™¨ (HTTP ${response.status})`);
        }

        const responseText = await response.text();
        console.log('æœå‹™å™¨éŸ¿æ‡‰:', responseText);
        
        let data;
        try {
          data = JSON.parse(responseText);
        } catch (parseError) {
          console.error('ç„¡æ³•è§£ææœå‹™å™¨éŸ¿æ‡‰:', parseError);
          throw new Error('æœå‹™å™¨è¿”å›çš„æ•¸æ“šæ ¼å¼éŒ¯èª¤');
        }

        if (!data.success) {
          // å¦‚æœæœå‹™å™¨ä¸æ”¯æŒ getPracticesï¼Œè¿”å›ç©ºæ•¸çµ„è€Œä¸æ˜¯æ‹‹å‡ºéŒ¯èª¤
          if (data.error && data.error.includes('Invalid parameters')) {
            console.warn('æœå‹™å™¨ä¸æ”¯æŒ getPractices æ“ä½œï¼Œä½¿ç”¨ç·©å­˜ç‰ˆæœ¬');
            return null; // è¿”å› null è¡¨ç¤ºç„¡æ³•ç²å–ï¼Œä½¿ç”¨ç·©å­˜
          }
          throw new Error(data.error || 'ç²å–ç·´ç¿’æ¸…å–®å¤±æ•—');
        }

        if (data.practices && Array.isArray(data.practices)) {
          console.log('å¾æœå‹™å™¨ç²å–æœ€æ–°ç·´ç¿’æ¸…å–®ï¼Œå…±', data.practices.length, 'å€‹ç·´ç¿’');
          return data.practices;
        } else {
          throw new Error('æœå‹™å™¨è¿”å›çš„ç·´ç¿’æ¸…å–®æ ¼å¼éŒ¯èª¤');
        }
      } catch (error) {
        console.error('å¾æœå‹™å™¨ç²å–ç·´ç¿’æ¸…å–®å¤±æ•—:', error);
        // å¦‚æœæ˜¯åƒæ•¸éŒ¯èª¤ï¼Œè¿”å› null è€Œä¸æ˜¯æ‹‹å‡ºéŒ¯èª¤ï¼Œè®“èª¿ç”¨è€…ä½¿ç”¨ç·©å­˜
        if (error.message && error.message.includes('Invalid parameters')) {
          console.warn('æœå‹™å™¨ä¸æ”¯æŒæ­¤æ“ä½œï¼Œä½¿ç”¨ç·©å­˜ç‰ˆæœ¬');
          return null;
        }
        throw error;
      }
    }

    // ç”Ÿæˆé€²åº¦éµï¼ˆæ”¯æŒå¤šå€‹ç·´ç¿’åŒæ™‚é€²è¡Œï¼‰
    function getProgressKey(practiceId, studentName) {
      return `${practiceId}_${studentName}`;
    }

    // ä¿å­˜ç·´ç¿’é€²åº¦åˆ° localStorageï¼ˆæ”¯æŒå¤šå€‹ç·´ç¿’åŒæ™‚é€²è¡Œï¼‰
    function savePracticeProgress() {
      try {
        if (!currentPractice || !currentStudentName) {
          return; // æ²’æœ‰é€²è¡Œä¸­çš„ç·´ç¿’ï¼Œä¸éœ€è¦ä¿å­˜
        }

        const progress = {
          practiceId: currentPractice.id,
          practiceName: currentPractice.name,
          csvUrl: currentPractice.csvUrl,
          studentName: currentStudentName,
          courseCode: getCurrentCourseCode(),
          currentQIndex: currentQIndex,
          historyData: historyData,
          score: score,
          timestamp: Date.now()
        };

        // è®€å–æ‰€æœ‰é€²åº¦
        const allProgress = getAllPracticeProgress();
        // æ›´æ–°ç•¶å‰ç·´ç¿’çš„é€²åº¦
        const progressKey = getProgressKey(currentPractice.id, currentStudentName);
        allProgress[progressKey] = progress;
        
        // ä¿å­˜æ‰€æœ‰é€²åº¦
        localStorage.setItem(PRACTICE_PROGRESS_KEY, JSON.stringify(allProgress));
        console.log('ç·´ç¿’é€²åº¦å·²ä¿å­˜:', {
          practiceId: progress.practiceId,
          studentName: progress.studentName,
          currentQIndex: progress.currentQIndex,
          totalAnswered: progress.historyData.length
        });
      } catch (error) {
        console.error('ä¿å­˜ç·´ç¿’é€²åº¦å¤±æ•—:', error);
      }
    }

    // ç²å–æ‰€æœ‰ç·´ç¿’é€²åº¦
    function getAllPracticeProgress() {
      try {
        const stored = localStorage.getItem(PRACTICE_PROGRESS_KEY);
        if (!stored) {
          return {};
        }
        return JSON.parse(stored);
      } catch (error) {
        console.error('è®€å–ç·´ç¿’é€²åº¦å¤±æ•—:', error);
        return {};
      }
    }

    // å¾ localStorage æ¢å¾©ç‰¹å®šç·´ç¿’çš„é€²åº¦
    function loadPracticeProgress(practiceId, studentName) {
      try {
        const allProgress = getAllPracticeProgress();
        if (!practiceId || !studentName) {
          // å¦‚æœæ²’æœ‰æŒ‡å®šåƒæ•¸ï¼Œå˜—è©¦ç²å–ç•¶å‰ç·´ç¿’çš„é€²åº¦
          if (currentPractice && currentStudentName) {
            const progressKey = getProgressKey(currentPractice.id, currentStudentName);
            return allProgress[progressKey] || null;
          }
          return null;
        }

        const progressKey = getProgressKey(practiceId, studentName);
        const progress = allProgress[progressKey];
        
        if (!progress) {
          return null;
        }

        // æª¢æŸ¥æ•¸æ“šæ˜¯å¦å®Œæ•´
        if (!progress.practiceId || !progress.studentName || !progress.csvUrl) {
          console.warn('ç·´ç¿’é€²åº¦æ•¸æ“šä¸å®Œæ•´ï¼Œæ¸…é™¤èˆŠæ•¸æ“š');
          clearPracticeProgress(practiceId, studentName);
          return null;
        }

        return progress;
      } catch (error) {
        console.error('æ¢å¾©ç·´ç¿’é€²åº¦å¤±æ•—:', error);
        return null;
      }
    }

    // æ¸…é™¤ç‰¹å®šç·´ç¿’çš„é€²åº¦ï¼ˆå¦‚æœä¸æŒ‡å®šï¼Œæ¸…é™¤ç•¶å‰ç·´ç¿’çš„é€²åº¦ï¼‰
    function clearPracticeProgress(practiceId, studentName) {
      try {
        if (practiceId && studentName) {
          // æ¸…é™¤æŒ‡å®šç·´ç¿’çš„é€²åº¦
          const allProgress = getAllPracticeProgress();
          const progressKey = getProgressKey(practiceId, studentName);
          delete allProgress[progressKey];
          localStorage.setItem(PRACTICE_PROGRESS_KEY, JSON.stringify(allProgress));
          console.log('ç·´ç¿’é€²åº¦å·²æ¸…é™¤:', progressKey);
        } else if (currentPractice && currentStudentName) {
          // æ¸…é™¤ç•¶å‰ç·´ç¿’çš„é€²åº¦
          const allProgress = getAllPracticeProgress();
          const progressKey = getProgressKey(currentPractice.id, currentStudentName);
          delete allProgress[progressKey];
          localStorage.setItem(PRACTICE_PROGRESS_KEY, JSON.stringify(allProgress));
          console.log('ç•¶å‰ç·´ç¿’é€²åº¦å·²æ¸…é™¤');
        } else {
          // æ¸…é™¤æ‰€æœ‰é€²åº¦ï¼ˆå‘å¾Œå…¼å®¹ï¼‰
          localStorage.removeItem(PRACTICE_PROGRESS_KEY);
          console.log('æ‰€æœ‰ç·´ç¿’é€²åº¦å·²æ¸…é™¤');
        }
      } catch (error) {
        console.error('æ¸…é™¤ç·´ç¿’é€²åº¦å¤±æ•—:', error);
      }
    }

    // ç²å–æŒ‡å®šå­¸ç”Ÿçš„æ‰€æœ‰æœªå®Œæˆç·´ç¿’é€²åº¦
    function getStudentProgress(studentName) {
      try {
        const allProgress = getAllPracticeProgress();
        const studentProgress = {};
        
        for (const [key, progress] of Object.entries(allProgress)) {
          if (progress.studentName === studentName) {
            studentProgress[progress.practiceId] = progress;
          }
        }
        
        return studentProgress;
      } catch (error) {
        console.error('ç²å–å­¸ç”Ÿé€²åº¦å¤±æ•—:', error);
        return {};
      }
    }

    // æª¢æŸ¥æ˜¯å¦æœ‰æœªå®Œæˆçš„ç·´ç¿’ï¼ˆæª¢æŸ¥æŒ‡å®šç·´ç¿’ï¼‰
    function hasUnfinishedPractice(practiceId, studentName) {
      const progress = loadPracticeProgress(practiceId, studentName);
      if (!progress) return false;

      // æª¢æŸ¥æ˜¯å¦èˆ‡ç•¶å‰èª²ç¨‹åŒ¹é…
      const courseCode = getCurrentCourseCode();
      if (!courseCode) return false;

      // æª¢æŸ¥ç·´ç¿’æ˜¯å¦é‚„å­˜åœ¨æ–¼ç•¶å‰èª²ç¨‹ä¸­
      const practice = PRACTICES.find(p => p.id === progress.practiceId && p.courseCode === courseCode);
      if (!practice) {
        // ç·´ç¿’ä¸å­˜åœ¨ï¼Œæ¸…é™¤èˆŠé€²åº¦
        clearPracticeProgress(practiceId, studentName);
        return false;
      }

      return true;
    }

    // æ¸…é™¤ç™»å…¥ç‹€æ…‹
    function clearLogin() {
      sessionStorage.removeItem(LOGIN_SESSION_KEY);
      sessionStorage.removeItem(COURSE_CODE_KEY);
      sessionStorage.removeItem(PRACTICES_STORAGE_KEY);
    }

    // è¨ªå•æ—¥èªŒåŠŸèƒ½
    function logAccess(type, success = true, details = '') {
      try {
        const logs = JSON.parse(localStorage.getItem(ACCESS_LOG_KEY) || '[]');
        const logEntry = {
          timestamp: new Date().toISOString(),
          type: type, // 'login_attempt', 'practice_start', 'devtools_detected'
          success: success,
          details: details,
          userAgent: navigator.userAgent.substring(0, 100) // é™åˆ¶é•·åº¦
        };
        
        logs.unshift(logEntry); // æ·»åŠ åˆ°é–‹é ­
        // åªä¿ç•™æœ€è¿‘çš„è¨˜éŒ„
        if (logs.length > MAX_LOG_ENTRIES) {
          logs.splice(MAX_LOG_ENTRIES);
        }
        
        localStorage.setItem(ACCESS_LOG_KEY, JSON.stringify(logs));
      } catch (e) {
        // å¿½ç•¥æ—¥èªŒéŒ¯èª¤ï¼Œä¸å½±éŸ¿ä¸»è¦åŠŸèƒ½
        console.error('æ—¥èªŒè¨˜éŒ„å¤±æ•—:', e);
      }
    }

    function getAccessLogs() {
      try {
        return JSON.parse(localStorage.getItem(ACCESS_LOG_KEY) || '[]');
      } catch (e) {
        return [];
      }
    }

    function clearAccessLogs() {
      localStorage.removeItem(ACCESS_LOG_KEY);
    }

    // å¾—åˆ†ç®¡ç†å‡½æ•¸ï¼ˆä½¿ç”¨ Google Spreadsheetï¼‰
    async function saveScore(studentName, practiceId, practiceName, score, courseCode) {
      // å¦‚æœæ²’æœ‰è¨­ç½® Google Apps Script URLï¼Œä½¿ç”¨ localStorage ä½œç‚ºå‚™ä»½
      if (!GOOGLE_APPS_SCRIPT_URL) {
        try {
          const scores = JSON.parse(localStorage.getItem(SCORES_STORAGE_KEY) || '[]');
          const scoreEntry = {
            studentName: studentName,
            practiceId: practiceId,
            practiceName: practiceName,
            score: score,
            courseCode: courseCode,
            timestamp: new Date().toISOString()
          };
          
          const existingIndex = scores.findIndex(
            s => s.studentName === studentName && 
                 s.practiceId === practiceId && 
                 s.courseCode === courseCode
          );
          
          if (existingIndex >= 0) {
            if (score > scores[existingIndex].score) {
              scores[existingIndex] = scoreEntry;
            }
          } else {
            scores.push(scoreEntry);
          }
          
          localStorage.setItem(SCORES_STORAGE_KEY, JSON.stringify(scores));
        } catch (e) {
          console.error('ä¿å­˜å¾—åˆ†å¤±æ•—:', e);
        }
        return;
      }

      // ç™¼é€åˆ° Google Spreadsheet
      try {
        const scoreData = {
          action: 'saveScore',
          studentName: studentName,
          practiceId: practiceId,
          practiceName: practiceName,
          score: score,
          courseCode: courseCode,
          timestamp: new Date().toISOString()
        };

        const response = await fetch(GOOGLE_APPS_SCRIPT_URL, {
          method: 'POST',
          mode: 'no-cors', // Google Apps Script éœ€è¦ no-cors
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(scoreData)
        });

        // æ³¨æ„ï¼šno-cors æ¨¡å¼ä¸‹ç„¡æ³•è®€å–éŸ¿æ‡‰ï¼Œä½†æ•¸æ“šæ‡‰è©²å·²ç™¼é€
        console.log('å¾—åˆ†å·²ç™¼é€åˆ°è³‡æ–™åº«');
      } catch (e) {
        console.error('ä¿å­˜å¾—åˆ†åˆ°è³‡æ–™åº«å¤±æ•—:', e);
        // å¤±æ•—æ™‚ä½¿ç”¨ localStorage ä½œç‚ºå‚™ä»½
        try {
          const scores = JSON.parse(localStorage.getItem(SCORES_STORAGE_KEY) || '[]');
          scores.push({
            studentName: studentName,
            practiceId: practiceId,
            practiceName: practiceName,
            score: score,
            courseCode: courseCode,
            timestamp: new Date().toISOString()
          });
          localStorage.setItem(SCORES_STORAGE_KEY, JSON.stringify(scores));
        } catch (backupError) {
          console.error('å‚™ä»½ä¿å­˜ä¹Ÿå¤±æ•—:', backupError);
        }
      }
    }

    async function getAllScoresByCourse(courseCode) {
      // å¿…é ˆå¾ Google Spreadsheet è®€å–
      if (!GOOGLE_APPS_SCRIPT_URL) {
        console.warn('æœªè¨­ç½®ä¼ºæœå™¨é€£æ¥ï¼Œç„¡æ³•å¾è³‡æ–™åº«è®€å–å¾—åˆ†');
        return []; // è¿”å›ç©ºæ•¸çµ„ï¼Œé¡¯ç¤ºã€Œæš«ç„¡å¾—åˆ†è¨˜éŒ„ã€
      }

      // å¾ Google Spreadsheet è®€å–
      try {
        const response = await fetch(`${GOOGLE_APPS_SCRIPT_URL}?action=getScores&courseCode=${encodeURIComponent(courseCode)}`, {
          method: 'GET',
          mode: 'cors',
          cache: 'no-cache',
          headers: {
            'Accept': 'application/json'
          }
        }).catch(fetchError => {
          console.error('è®€å–å¾—åˆ†æ™‚ Fetch éŒ¯èª¤:', fetchError);
          throw new Error(`ç„¡æ³•é€£æ¥åˆ°æœå‹™å™¨: ${fetchError.message}`);
        });
        
        if (!response.ok) {
          const errorText = await response.text().catch(() => 'ç„¡æ³•è®€å–éŒ¯èª¤ä¿¡æ¯');
          throw new Error(`HTTP éŒ¯èª¤: ${response.status} - ${errorText}`);
        }
        
        const responseText = await response.text();
        let data;
        try {
          data = JSON.parse(responseText);
        } catch (parseError) {
          console.error('è§£æå¾—åˆ†éŸ¿æ‡‰å¤±æ•—:', parseError);
          throw new Error('æœå‹™å™¨è¿”å›çš„æ•¸æ“šæ ¼å¼éŒ¯èª¤');
        }
        
        if (!data.success) {
          throw new Error(data.error || 'è®€å–å¾—åˆ†å¤±æ•—');
        }
        
        // ç¢ºä¿åˆ†æ•¸æ˜¯æ•¸å­—é¡å‹ï¼Œä¸¦è™•ç†å¯èƒ½çš„å­—ç¬¦ä¸²
        const scores = (data.scores || []).map(scoreEntry => ({
          ...scoreEntry,
          score: typeof scoreEntry.score === 'string' 
            ? parseFloat(scoreEntry.score) || 0 
            : Number(scoreEntry.score) || 0
        }));
        
        return scores;
      } catch (e) {
        console.error('å¾è³‡æ–™åº«è®€å–å¾—åˆ†å¤±æ•—:', e);
        // ä¸è¿”å›å‚™ä»½æ•¸æ“šï¼Œç¢ºä¿åªå¾è³‡æ–™åº«è®€å–
        throw e; // æ‹‹å‡ºéŒ¯èª¤ï¼Œè®“èª¿ç”¨è€…è™•ç†
      }
    }

    // æ³¨æ„ï¼šå·²ç§»é™¤å¯†ç¢¼è¨­ç½®åŠŸèƒ½ï¼Œå¯†ç¢¼ç”±è€å¸«åœ¨ä»£ç¢¼ä¸­é è¨­

    // ç™»å…¥ï¼ˆé€šé Google Apps Script é©—è­‰ï¼‰
    window.login = async function() {
      // æ¸…ç†å’Œé©—è­‰è¼¸å…¥
      const rawCourseCode = document.getElementById('login-course-code-input').value.trim();
      const courseCode = sanitizeInput(rawCourseCode).toUpperCase();
      const password = document.getElementById('login-password-input').value;
      const errorEl = document.getElementById('login-error');

      if (!courseCode) {
        errorEl.innerText = 'è«‹è¼¸å…¥èª²ç¨‹ç·¨è™Ÿ';
        return;
      }

      if (!password) {
        errorEl.innerText = 'è«‹è¼¸å…¥å¯†ç¢¼';
        return;
      }

      // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
      errorEl.innerText = 'æ­£åœ¨é©—è­‰...';
      errorEl.style.color = '#666';
      const loginButton = document.querySelector('#password-login-screen ion-button');
      loginButton.disabled = true;
      loginButton.innerHTML = '<ion-spinner name="crescent"></ion-spinner> é©—è­‰ä¸­...';

      try {
        // é€šé Google Apps Script é©—è­‰èª²ç¨‹ä¸¦ç²å–ç·´ç¿’æ¸…å–®
        if (!GOOGLE_APPS_SCRIPT_URL) {
          throw new Error('æœªè¨­ç½®ä¼ºæœå™¨é€£æ¥ï¼Œè«‹è¯ç¹«ç®¡ç†å“¡');
        }

        const urlParams = new URLSearchParams({
          action: 'verifyCourse',
          courseCode: courseCode,
          password: password
        });
        const requestUrl = `${GOOGLE_APPS_SCRIPT_URL}?${urlParams.toString()}`;
        
        // èª¿è©¦ä¿¡æ¯
        console.log('ç™»å…¥è«‹æ±‚ URL:', requestUrl);
        console.log('èª²ç¨‹ç·¨è™Ÿ:', courseCode);
        console.log('ä¼ºæœå™¨é€£æ¥å·²è¨­ç½®:', !!GOOGLE_APPS_SCRIPT_URL);

        const response = await fetch(requestUrl, {
          method: 'GET',
          mode: 'cors',
          cache: 'no-cache',
          headers: {
            'Accept': 'application/json'
          }
        }).catch(fetchError => {
          // æ•è·ç½‘ç»œé”™è¯¯
          console.error('Fetch éŒ¯èª¤è©³æƒ…:', fetchError);
          throw new Error(`ç„¡æ³•é€£æ¥åˆ°ä¼ºæœå™¨ã€‚è«‹æª¢æŸ¥ï¼š\n1. ç¶²è·¯é€£æ¥æ˜¯å¦æ­£å¸¸\n2. ä¼ºæœå™¨é€£æ¥è¨­å®šæ˜¯å¦æ­£ç¢º\n3. ä¼ºæœå™¨æ˜¯å¦å·²æ­£ç¢ºéƒ¨ç½²\n\néŒ¯èª¤è©³æƒ…: ${fetchError.message}`);
        });

        if (!response.ok) {
          const errorText = await response.text().catch(() => 'ç„¡æ³•è®€å–éŒ¯èª¤ä¿¡æ¯');
          throw new Error(`ç„¡æ³•é€£æ¥åˆ°æœå‹™å™¨ (HTTP ${response.status})\n${errorText}`);
        }

        let data;
        try {
          const responseText = await response.text();
          data = JSON.parse(responseText);
        } catch (parseError) {
          console.error('è§£æéŸ¿æ‡‰å¤±æ•—:', parseError);
          throw new Error('ä¼ºæœå™¨è¿”å›çš„æ•¸æ“šæ ¼å¼éŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ä¼ºæœå™¨é…ç½®');
        }

        if (!data.success) {
          // é©—è­‰å¤±æ•—
          errorEl.innerText = data.error || 'é©—è­‰å¤±æ•—ï¼Œè«‹æª¢æŸ¥èª²ç¨‹ç·¨è™Ÿå’Œå¯†ç¢¼';
          errorEl.style.color = 'var(--ion-color-danger)';
          logAccess('login_attempt', false, `èª²ç¨‹ç·¨è™Ÿ: ${courseCode}, éŒ¯èª¤: ${data.error}`);
          document.getElementById('login-password-input').value = '';
          
          // å¦‚æœæ˜¯èª²ç¨‹éæœŸï¼Œé¡¯ç¤ºéæœŸæ—¥æœŸ
          if (data.error === 'èª²ç¨‹å·²éæœŸ' && data.expiryDate) {
            errorEl.innerText = `èª²ç¨‹å·²éæœŸï¼ˆæœ‰æ•ˆæœŸè‡³ï¼š${data.expiryDate}ï¼‰`;
          }
          
          loginButton.disabled = false;
          loginButton.innerHTML = 'ç™»å…¥';
          return;
        }

        // é©—è­‰æˆåŠŸï¼Œä¿å­˜ç·´ç¿’æ¸…å–®
        if (data.practices && Array.isArray(data.practices)) {
          PRACTICES = data.practices;
          console.log('æˆåŠŸè¼‰å…¥ç·´ç¿’æ¸…å–®ï¼Œå…±', PRACTICES.length, 'å€‹ç·´ç¿’');
          // ä¿å­˜åˆ° sessionStorageï¼Œä»¥ä¾¿åˆ·æ–°å¾Œæ¢å¾©
          savePracticesToStorage(PRACTICES, courseCode);
        } else {
          console.warn('æœªè¿”å›ç·´ç¿’æ¸…å–®æˆ–æ ¼å¼éŒ¯èª¤');
          PRACTICES = [];
        }

        // ç™»å…¥æˆåŠŸ
        errorEl.innerText = '';
        setLoggedIn(courseCode); // è¨­ç½®ç™»å…¥ç‹€æ…‹å’Œèª²ç¨‹ç·¨è™Ÿ
        logAccess('login_attempt', true, `ç™»å…¥æˆåŠŸ - èª²ç¨‹ç·¨è™Ÿ: ${courseCode}`);
        
        loginButton.disabled = false;
        loginButton.innerHTML = 'ç™»å…¥';
        
        showPracticeSelect();
        
      } catch (error) {
        console.error('ç™»å…¥éŒ¯èª¤:', error);
        
        // æä¾›æ›´å‹å¥½çš„éŒ¯èª¤ä¿¡æ¯
        let errorMessage = error.message || 'æœªçŸ¥éŒ¯èª¤';
        
        // å¦‚æœæ˜¯ç¶²çµ¡éŒ¯èª¤ï¼Œæä¾›æ›´è©³ç´°çš„å¹«åŠ©ä¿¡æ¯
        if (error.message && (error.message.includes('Failed to fetch') || error.message.includes('NetworkError') || error.message.includes('ç„¡æ³•é€£æ¥åˆ°æœå‹™å™¨'))) {
          errorMessage = `ç„¡æ³•é€£æ¥åˆ°ä¼ºæœå™¨\n\nå¯èƒ½çš„åŸå› ï¼š\n1. ç¶²è·¯é€£æ¥å•é¡Œ\n2. ä¼ºæœå™¨æœªæ­£ç¢ºéƒ¨ç½²\n3. ä¼ºæœå™¨é€£æ¥è¨­å®šéŒ¯èª¤\n\nè«‹æª¢æŸ¥ï¼š\n- ç¶²è·¯é€£æ¥æ˜¯å¦æ­£å¸¸\n- ä¼ºæœå™¨æ˜¯å¦å·²æ­£ç¢ºéƒ¨ç½²\n- ä¼ºæœå™¨é€£æ¥è¨­å®šæ˜¯å¦æ­£ç¢º\n- è«‹è¯ç¹«ç®¡ç†å“¡æª¢æŸ¥ä¼ºæœå™¨ç‹€æ…‹`;
        }
        
        errorEl.innerText = `ç™»å…¥å¤±æ•—ï¼š${errorMessage}`;
        errorEl.style.color = 'var(--ion-color-danger)';
        errorEl.style.whiteSpace = 'pre-line'; // å…è¨±æ›è¡Œé¡¯ç¤º
        logAccess('login_attempt', false, `èª²ç¨‹ç·¨è™Ÿ: ${courseCode}, éŒ¯èª¤: ${error.message}`);
        
        loginButton.disabled = false;
        loginButton.innerHTML = 'ç™»å…¥';
      }
    }

    // ç™»å‡º
    window.logout = function() {
      clearLogin(); // æ¸…é™¤ç™»å…¥ç‹€æ…‹
      hideAllScreens();
      showPasswordLogin();
    }

    // é¡¯ç¤ºç·´ç¿’é¸æ“‡ç•«é¢
    function showPracticeSelect() {
      hideAllScreens();
      disableContentProtection();
      removeWatermark();
      practiceSelectScreen.classList.remove('hidden');
      
      // å‹•æ…‹ä¿®æ”¹å®¹å™¨æ¨£å¼ä»¥å……åˆ†åˆ©ç”¨å¯¬åº¦
      const quizContainer = document.querySelector('.quiz-container');
      if (quizContainer) {
        quizContainer.style.maxWidth = '100%';
        quizContainer.style.width = '100%';
        quizContainer.style.padding = '0';
      }
      
      const currentCourseCode = getCurrentCourseCode();
      const practiceList = document.getElementById('practice-list');
      practiceList.innerHTML = '';

      // é¡¯ç¤ºç•¶å‰èª²ç¨‹ç·¨è™Ÿ
      const courseCodeDisplay = document.getElementById('current-course-code-display');
      if (courseCodeDisplay) {
        courseCodeDisplay.textContent = currentCourseCode;
      }

      // ç²å–ç•¶å‰å­¸ç”Ÿçš„æ‰€æœ‰é€²åº¦ï¼ˆå¦‚æœæœ‰çš„è©±ï¼‰
      // æ³¨æ„ï¼šé€™è£¡æˆ‘å€‘éœ€è¦çŸ¥é“å­¸ç”Ÿå§“åï¼Œä½†å¯èƒ½é‚„æ²’æœ‰è¼¸å…¥
      // æ‰€ä»¥æˆ‘å€‘å…ˆé¡¯ç¤ºæ‰€æœ‰ç·´ç¿’ï¼Œç„¶å¾Œåœ¨é¸æ“‡æ™‚æª¢æŸ¥é€²åº¦

      // é¡¯ç¤ºæ’è¡Œæ¦œï¼ˆç•°æ­¥ï¼‰
      displayLeaderboard(currentCourseCode).catch(err => {
        console.error('é¡¯ç¤ºæ’è¡Œæ¦œå¤±æ•—:', err);
      });

      // æ ¹æ“šèª²ç¨‹ç·¨è™Ÿéæ¿¾ç·´ç¿’
      const filteredPractices = PRACTICES.filter(practice => practice.courseCode === currentCourseCode);

      if (filteredPractices.length === 0) {
        practiceList.innerHTML = `
          <ion-card>
            <ion-card-content class="ion-text-center" style="padding: 40px 20px;">
              <ion-icon name="document-outline" style="font-size: 48px; color: #999; margin-bottom: 10px;"></ion-icon>
              <p style="color: #666;">æ­¤èª²ç¨‹ç·¨è™Ÿæš«ç„¡å¯ç”¨ç·´ç¿’</p>
            </ion-card-content>
          </ion-card>
        `;
        return;
      }

      filteredPractices.forEach((practice, index) => {
        const card = document.createElement('ion-card');
        card.className = 'practice-card';
        
        // æª¢æŸ¥æ˜¯å¦æœ‰ä»»ä½•å­¸ç”Ÿå°é€™å€‹ç·´ç¿’æœ‰é€²åº¦ï¼ˆé¡¯ç¤ºé€²åº¦æç¤ºï¼‰
        const allProgress = getAllPracticeProgress();
        let progressInfo = null;
        for (const [key, progress] of Object.entries(allProgress)) {
          // æª¢æŸ¥ç·´ç¿’IDå’Œèª²ç¨‹ç·¨è™Ÿæ˜¯å¦åŒ¹é…
          if (progress.practiceId === practice.id && 
              (progress.courseCode === currentCourseCode || !progress.courseCode)) {
            progressInfo = progress;
            break;
          }
        }
        
        // å¦‚æœæœ‰é€²åº¦ï¼Œé¡¯ç¤ºé€²åº¦ä¿¡æ¯ï¼ˆåªé¡¯ç¤ºæœªå®Œæˆçš„ï¼‰
        let progressBadge = '';
        if (progressInfo) {
          // ç¢ºä¿é€²åº¦ä¿¡æ¯å­˜åœ¨ä¸”æœ‰æ•ˆ
          const studentName = progressInfo.studentName || 'æœªçŸ¥';
          const answeredCount = progressInfo.historyData ? progressInfo.historyData.length : 0;
          progressBadge = `
            <div style="margin-top: 8px; padding: 6px 10px; background-color: #eff6ff; border-radius: 4px; border-left: 3px solid var(--ion-color-primary);">
              <p style="margin: 0; color: var(--ion-color-primary); font-size: 0.8em; font-weight: 500;">
                <ion-icon name="time-outline" style="vertical-align: middle; margin-right: 4px;"></ion-icon>
                æœªå®Œæˆï¼šå­¸ç”Ÿ ${escapeHtml(studentName)} | å·²ç­” ${answeredCount} é¡Œ
              </p>
            </div>
          `;
        }
        
        card.innerHTML = `
          <ion-card-content style="padding: 14px;">
            <div style="display: flex; align-items: flex-start; gap: 10px;">
              <ion-icon name="${progressInfo ? 'play-circle' : 'document-text'}" style="font-size: 28px; color: ${progressInfo ? 'var(--ion-color-primary)' : 'var(--ion-color-primary)'}; flex-shrink: 0; margin-top: 2px;"></ion-icon>
              <div style="flex: 1; min-width: 0;">
                <h3 style="margin: 0 0 6px 0; font-weight: 600; font-size: 1em; line-height: 1.3;">${escapeHtml(practice.name || '')}</h3>
                <p style="margin: 0 0 4px 0; color: #666; font-size: 0.85em; line-height: 1.4;">${escapeHtml(practice.description || '')}</p>
                <p style="margin: 0; color: #999; font-size: 0.75em;">åŠæ ¼: ${escapeHtml(String(practice.passingScore || 0))} åˆ†</p>
                ${progressBadge}
              </div>
            </div>
          </ion-card-content>
        `;
        card.onclick = () => selectPractice(practice);
        practiceList.appendChild(card);
      });
    }

    // é¡¯ç¤ºæ’è¡Œæ¦œï¼ˆç•°æ­¥ï¼‰
    async function displayLeaderboard(courseCode) {
      const leaderboardContainer = document.getElementById('leaderboard-container');
      if (!leaderboardContainer) return;

      // é¡¯ç¤ºè¼‰å…¥ä¸­
      leaderboardContainer.innerHTML = `
        <ion-card>
          <ion-card-content class="ion-text-center" style="padding: 20px;">
            <ion-spinner name="crescent" color="primary"></ion-spinner>
            <p style="color: #666; font-size: 0.9em; margin-top: 10px;">è¼‰å…¥æ’è¡Œæ¦œä¸­...</p>
          </ion-card-content>
        </ion-card>
      `;

      try {
        // æª¢æŸ¥æ˜¯å¦è¨­ç½®äº† Google Apps Script URL
        if (!GOOGLE_APPS_SCRIPT_URL) {
          leaderboardContainer.innerHTML = `
            <ion-card>
              <ion-card-content class="ion-text-center" style="padding: 20px;">
                <ion-icon name="warning-outline" style="font-size: 32px; color: #ffc409; margin-bottom: 10px;"></ion-icon>
                <p style="color: #666; font-size: 0.9em; margin-bottom: 5px;">æœªè¨­ç½®è³‡æ–™åº«é€£æ¥</p>
                <p style="color: #999; font-size: 0.8em;">è«‹è¯ç¹«ç®¡ç†å“¡è¨­ç½®ä¼ºæœå™¨é€£æ¥</p>
              </ion-card-content>
            </ion-card>
          `;
          return;
        }

        const allScores = await getAllScoresByCourse(courseCode);
        
        // èª¿è©¦ï¼šæª¢æŸ¥æ•¸æ“š
        console.log('å¾è³‡æ–™åº«è®€å–çš„å¾—åˆ†æ•¸æ“š:', allScores);
        console.log('æ•¸æ“šæ•¸é‡:', allScores.length);
        
        if (allScores.length === 0) {
          leaderboardContainer.innerHTML = `
            <ion-card>
              <ion-card-content class="ion-text-center" style="padding: 20px;">
                <p style="color: #666; font-size: 0.9em;">æš«ç„¡å¾—åˆ†è¨˜éŒ„</p>
                <p style="color: #999; font-size: 0.8em; margin-top: 5px;">æ•¸æ“šå¾è³‡æ–™åº«è®€å–</p>
              </ion-card-content>
            </ion-card>
          `;
          return;
        }

      // è¨ˆç®—3å€‹æœˆå‰çš„æ™‚é–“æˆ³
      const threeMonthsAgo = new Date();
      threeMonthsAgo.setMonth(threeMonthsAgo.getMonth() - 3);
      const threeMonthsAgoTimestamp = threeMonthsAgo.getTime();
      
      // éæ¿¾æ‰è¶…é3å€‹æœˆçš„è¨˜éŒ„
      const recentScores = allScores.filter(scoreEntry => {
        if (!scoreEntry.timestamp) {
          // å¦‚æœæ²’æœ‰æ™‚é–“æˆ³ï¼Œä¿ç•™è¨˜éŒ„ï¼ˆå‘å¾Œå…¼å®¹ï¼‰
          return true;
        }
        
        // è§£ææ™‚é–“æˆ³ï¼ˆå¯èƒ½æ˜¯ ISO å­—ç¬¦ä¸²æˆ–æ•¸å­—ï¼‰
        let timestamp;
        if (typeof scoreEntry.timestamp === 'string') {
          timestamp = new Date(scoreEntry.timestamp).getTime();
        } else {
          timestamp = scoreEntry.timestamp;
        }
        
        // åªä¿ç•™3å€‹æœˆå…§çš„è¨˜éŒ„
        return timestamp >= threeMonthsAgoTimestamp;
      });
      
      // æŒ‰ç·´ç¿’åˆ†çµ„
      const practicesInCourse = PRACTICES.filter(p => p.courseCode === courseCode);
      let leaderboardHTML = '';

      practicesInCourse.forEach(practice => {
        const practiceScores = recentScores
          .filter(s => s.practiceId === practice.id)
          .map(s => ({
            ...s,
            score: Number(s.score) || 0 // ç¢ºä¿åˆ†æ•¸æ˜¯æ•¸å­—
          }))
          .sort((a, b) => {
            // ç¢ºä¿ä½¿ç”¨æ•¸å­—æ¯”è¼ƒ
            const scoreA = Number(a.score) || 0;
            const scoreB = Number(b.score) || 0;
            return scoreB - scoreA; // é™åºæ’åˆ—
          })
          .slice(0, 10); // æ¯å€‹ç·´ç¿’åªé¡¯ç¤ºå‰10å

        if (practiceScores.length === 0) return;

        leaderboardHTML += `
          <ion-card style="width: 100%; box-sizing: border-box; display: flex; flex-direction: column; min-height: 280px; max-height: none; overflow: visible;">
            <ion-card-header style="flex-shrink: 0; padding: 12px 16px;">
              <ion-card-title style="font-size: 0.95em; line-height: 1.3;">${escapeHtml(practice.name || '')}</ion-card-title>
            </ion-card-header>
            <ion-card-content style="padding: 8px 12px; width: 100%; box-sizing: border-box; flex: 1; overflow-y: auto; overflow-x: visible; min-height: 0; max-height: none;">
              <ion-list lines="none" style="width: 100%;">
        `;

        practiceScores.forEach((scoreEntry, index) => {
          const rank = index + 1;
          const medalIcon = rank === 1 ? 'ğŸ†' : rank === 2 ? 'ğŸ¥ˆ' : rank === 3 ? 'ğŸ¥‰' : '';
          const rankColor = rank === 1 ? '#FFD700' : rank === 2 ? '#C0C0C0' : rank === 3 ? '#CD7F32' : '#666';
          
          // ç¢ºä¿åˆ†æ•¸æ˜¯æ•¸å­—ä¸¦æ ¼å¼åŒ–
          const score = Math.round(Number(scoreEntry.score) || 0);
          const studentName = scoreEntry.studentName || 'æœªçŸ¥';
          
          leaderboardHTML += `
            <ion-item style="--padding-start: 0; --padding-end: 0; width: 100%; --min-height: 40px;">
              <div style="display: flex; align-items: center; width: 100%; gap: 8px; padding: 4px 0;">
                <div style="min-width: 28px; text-align: center; font-weight: bold; color: ${rankColor}; font-size: 0.95em; flex-shrink: 0;">
                  ${medalIcon || rank}
                </div>
                <div style="flex: 1; min-width: 0; overflow: hidden; text-overflow: ellipsis;">
                  <strong style="word-break: break-word; font-size: 0.9em; display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${escapeHtml(studentName || 'æœªçŸ¥')}</strong>
                </div>
                <div style="min-width: 55px; text-align: right; font-weight: bold; color: var(--ion-color-primary); flex-shrink: 0; font-size: 0.9em;">
                  ${score}åˆ†
                </div>
              </div>
            </ion-item>
          `;
        });

        leaderboardHTML += `
              </ion-list>
            </ion-card-content>
          </ion-card>
        `;
      });

        leaderboardContainer.innerHTML = leaderboardHTML || `
          <ion-card>
            <ion-card-content class="ion-text-center" style="padding: 20px;">
              <p style="color: #666; font-size: 0.9em;">æš«ç„¡å¾—åˆ†è¨˜éŒ„</p>
            </ion-card-content>
          </ion-card>
        `;
      } catch (error) {
        console.error('å¾è³‡æ–™åº«è¼‰å…¥æ’è¡Œæ¦œå¤±æ•—:', error);
        leaderboardContainer.innerHTML = `
          <ion-card>
            <ion-card-content class="ion-text-center" style="padding: 20px;">
              <ion-icon name="alert-circle-outline" style="font-size: 32px; color: var(--ion-color-danger); margin-bottom: 10px;"></ion-icon>
              <p style="color: var(--ion-color-danger); font-size: 0.9em; margin-bottom: 5px;">ç„¡æ³•å¾è³‡æ–™åº«è®€å–æ•¸æ“š</p>
              <p style="color: #999; font-size: 0.8em;">è«‹æª¢æŸ¥ï¼š</p>
              <ul style="text-align: left; color: #999; font-size: 0.8em; margin-top: 10px; padding-left: 20px;">
                <li>ä¼ºæœå™¨é€£æ¥è¨­å®šæ˜¯å¦æ­£ç¢º</li>
                <li>è³‡æ–™åº«æ¬Šé™è¨­ç½®</li>
                <li>ç¶²è·¯é€£æ¥æ˜¯å¦æ­£å¸¸</li>
              </ul>
            </ion-card-content>
          </ion-card>
        `;
      }
    }

    // é¸æ“‡ç·´ç¿’
    function selectPractice(practice) {
      currentPractice = practice;
      PASSING_SCORE = practice.passingScore;
      // é—œé–‰èœå–®ï¼ˆå¦‚æœæ˜¯æ‰‹æ©Ÿç‰ˆï¼‰
      closePracticeMenu();
      // å…ˆé¡¯ç¤ºå§“åè¼¸å…¥ç•Œé¢
      showNameInput();
    }

    // é¡¯ç¤ºå§“åè¼¸å…¥ç•Œé¢
    function showNameInput() {
      hideAllScreens();
      disableContentProtection();
      removeWatermark();
      
      // æª¢æŸ¥æ˜¯å¦æœ‰é€™å€‹ç·´ç¿’çš„æœªå®Œæˆé€²åº¦
      const allProgress = getAllPracticeProgress();
      const currentCourseCode = getCurrentCourseCode();
      let existingProgress = null;
      
      for (const [key, progress] of Object.entries(allProgress)) {
        if (progress.practiceId === currentPractice.id && 
            (progress.courseCode === currentCourseCode || !progress.courseCode)) {
          existingProgress = progress;
          break;
        }
      }
      
      // å¦‚æœæœ‰é€²åº¦ï¼Œç›´æ¥æ¢å¾©ï¼Œä¸éœ€è¦è¼¸å…¥å§“å
      if (existingProgress && existingProgress.studentName) {
        console.log('æª¢æ¸¬åˆ°æœªå®Œæˆçš„ç·´ç¿’ï¼Œç›´æ¥æ¢å¾©:', existingProgress);
        
        // è¨­ç½®æ‰€æœ‰å¿…è¦çš„è®Šé‡
        currentStudentName = existingProgress.studentName;
        currentQIndex = existingProgress.currentQIndex || 0;
        historyData = existingProgress.historyData || [];
        score = existingProgress.score || 0;
        
        // ç¢ºä¿ä½¿ç”¨æ­£ç¢ºçš„ CSV URL
        const csvUrl = existingProgress.csvUrl || currentPractice.csvUrl;
        
        console.log('æ¢å¾©é€²åº¦:', {
          practiceId: currentPractice.id,
          studentName: currentStudentName,
          currentQIndex: currentQIndex,
          historyLength: historyData.length,
          score: score
        });
        
        // ç›´æ¥æ¢å¾©ç·´ç¿’
        hideAllScreens();
        loadingScreen.classList.remove('hidden');
        loadQuestionsAndResume(csvUrl);
        return;
      }
      
      // æ²’æœ‰é€²åº¦ï¼Œé¡¯ç¤ºå§“åè¼¸å…¥ç•Œé¢
      nameInputScreen.classList.remove('hidden');
      document.getElementById('name-input-error').innerText = '';
      
      const nameInput = document.getElementById('student-name-input');
      nameInput.value = '';
      
      // è¨­ç½® Enter éµäº‹ä»¶
      const newNameInput = nameInput.cloneNode(true);
      nameInput.parentNode.replaceChild(newNameInput, nameInput);
      
      document.getElementById('student-name-input').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          startPracticeWithName();
        }
      });
      
      // è‡ªå‹•èšç„¦
      setTimeout(() => {
        document.getElementById('student-name-input').focus();
      }, 100);
    }

    // é–‹å§‹ç·´ç¿’ï¼ˆå¸¶å§“åï¼‰
    window.startPracticeWithName = function() {
      // æ¸…ç†å’Œé©—è­‰è¼¸å…¥
      const rawStudentName = document.getElementById('student-name-input').value.trim();
      const studentName = sanitizeInput(rawStudentName);
      const errorEl = document.getElementById('name-input-error');

      if (!studentName) {
        errorEl.innerText = 'è«‹è¼¸å…¥æ‚¨çš„å§“å';
        return;
      }

      if (studentName.length < 2) {
        errorEl.innerText = 'å§“åè‡³å°‘éœ€è¦2å€‹å­—å…ƒ';
        return;
      }

      if (studentName.length > 20) {
        errorEl.innerText = 'å§“åä¸èƒ½è¶…é20å€‹å­—å…ƒ';
        return;
      }

      // æª¢æŸ¥æ˜¯å¦æœ‰æœªå®Œæˆçš„ç·´ç¿’ï¼ˆåŒä¸€å€‹ç·´ç¿’å’Œå­¸ç”Ÿï¼‰
      const progress = loadPracticeProgress(currentPractice.id, studentName);
      if (progress && progress.practiceId === currentPractice.id && progress.studentName === studentName) {
        // è©¢å•æ˜¯å¦ç¹¼çºŒ
        if (confirm(`æª¢æ¸¬åˆ°æœªå®Œæˆçš„ç·´ç¿’ã€Œ${progress.practiceName}ã€\nå­¸ç”Ÿï¼š${studentName}\nå·²ç­” ${progress.historyData.length} é¡Œ\n\næ˜¯å¦ç¹¼çºŒï¼Ÿ`)) {
          currentStudentName = studentName;
          currentQIndex = progress.currentQIndex;
          historyData = progress.historyData || [];
          score = progress.score || 0;
          hideAllScreens();
          loadingScreen.classList.remove('hidden');
          loadQuestionsAndResume(currentPractice.csvUrl);
          return;
        } else {
          // é‡æ–°é–‹å§‹ï¼Œæ¸…é™¤é€™å€‹ç·´ç¿’çš„é€²åº¦
          clearPracticeProgress(currentPractice.id, studentName);
        }
      }

      // é–‹å§‹æ–°ç·´ç¿’
      currentStudentName = studentName;
      currentQIndex = 0;
      historyData = [];
      score = 0;
      errorEl.innerText = '';
      logAccess('practice_start', true, `é–‹å§‹ç·´ç¿’: ${currentPractice.name}, å­¸ç”Ÿ: ${studentName}`);
      hideAllScreens();
      loadingScreen.classList.remove('hidden');
      loadQuestions(currentPractice.csvUrl);
    }

    // éš±è—æ‰€æœ‰ç•«é¢
    function hideAllScreens() {
      passwordSetupScreen.classList.add('hidden');
      passwordLoginScreen.classList.add('hidden');
      
      // å¦‚æœéš±è—ç·´ç¿’é¸æ“‡ç•«é¢ï¼Œæ¢å¾©å®¹å™¨æ¨£å¼
      if (!practiceSelectScreen.classList.contains('hidden')) {
        const quizContainer = document.querySelector('.quiz-container');
        if (quizContainer) {
          quizContainer.style.maxWidth = '';
          quizContainer.style.width = '';
          quizContainer.style.padding = '';
        }
      }
      
      practiceSelectScreen.classList.add('hidden');
      nameInputScreen.classList.add('hidden');
      loadingScreen.classList.add('hidden');
      errorScreen.classList.add('hidden');
      quizScreen.classList.add('hidden');
      resultScreen.classList.add('hidden');
    }

    // è¿”å›ç·´ç¿’é¸æ“‡ï¼ˆå¾çµæœç•«é¢æˆ–å§“åè¼¸å…¥ç•«é¢ï¼‰
    window.backToPracticeSelect = function() {
      // æª¢æŸ¥æ˜¯å¦å¾çµæœç•«é¢è¿”å›
      const isFromResultScreen = !resultScreen.classList.contains('hidden');
      
      // å¦‚æœå¾çµæœç•«é¢è¿”å›ï¼Œèªªæ˜ç·´ç¿’å·²å®Œæˆï¼Œé€²åº¦å·²åœ¨ showResults() ä¸­æ¸…é™¤
      // ä¸éœ€è¦å†æ¬¡ä¿å­˜é€²åº¦ï¼Œä¸¦ä¸”æ‡‰è©²æ¸…é™¤ç›¸é—œè®Šé‡
      if (isFromResultScreen) {
        // æ¸…é™¤ç•¶å‰ç·´ç¿’ç›¸é—œè®Šé‡ï¼Œé¿å…é‡æ–°ä¿å­˜é€²åº¦
        currentPractice = null;
        currentStudentName = '';
        currentQIndex = 0;
        score = 0;
        historyData = [];
        console.log('å¾çµæœç•«é¢è¿”å›ï¼Œå·²æ¸…é™¤ç·´ç¿’ç›¸é—œè®Šé‡');
      } else {
        // å¾å…¶ä»–ç•«é¢è¿”å›ï¼Œä¿å­˜ç•¶å‰é€²åº¦ï¼ˆå¦‚æœæœ‰çš„è©±ï¼‰
        if (currentPractice && currentStudentName) {
          savePracticeProgress();
        }
      }
      
      hideAllScreens();
      showPracticeSelect();
    }

    // å¾ç·´ç¿’ç•«é¢è¿”å›ç·´ç¿’é¸æ“‡ï¼ˆä¿å­˜é€²åº¦ï¼‰
    window.backToPracticeSelectFromQuiz = function() {
      // ç¢ºèªæ˜¯å¦è¦è¿”å›
      if (confirm('ç¢ºå®šè¦è¿”å›ç·´ç¿’ç›®éŒ„å—ï¼Ÿç•¶å‰é€²åº¦æœƒè‡ªå‹•ä¿å­˜ï¼Œæ‚¨å¯ä»¥ç¨å¾Œç¹¼çºŒã€‚')) {
        // ä¿å­˜ç•¶å‰é€²åº¦
        if (currentPractice && currentStudentName) {
          savePracticeProgress();
          console.log('å·²ä¿å­˜é€²åº¦ä¸¦è¿”å›ç·´ç¿’ç›®éŒ„');
        }
        hideAllScreens();
        showPracticeSelect();
      }
    }

    // 1. CSV è§£æå™¨
    function parseCSV(text) {
      const rows = [];
      let currentRow = [];
      let currentCell = '';
      let insideQuote = false;

      for (let i = 0; i < text.length; i++) {
        const char = text[i];
        const nextChar = text[i + 1];

        if (char === '"') {
          if (insideQuote && nextChar === '"') {
            currentCell += '"'; 
            i++;
          } else {
            insideQuote = !insideQuote;
          }
        } else if (char === ',' && !insideQuote) {
          currentRow.push(currentCell.trim());
          currentCell = '';
        } else if ((char === '\r' || char === '\n') && !insideQuote) {
          if (currentCell || currentRow.length > 0) {
            currentRow.push(currentCell.trim());
            rows.push(currentRow);
          }
          currentRow = [];
          currentCell = '';
          if (char === '\r' && nextChar === '\n') i++;
        } else {
          currentCell += char;
        }
      }
      if (currentCell || currentRow.length > 0) {
        currentRow.push(currentCell.trim());
        rows.push(currentRow);
      }
      return rows;
    }

    // 2. å¾ Google Spreadsheet é€£çµä¸­æå– Spreadsheet ID
    function extractSpreadsheetId(url) {
      if (!url) {
        console.warn('extractSpreadsheetId: URL ç‚ºç©º');
        return null;
      }
      
      // å¾å„ç¨®æ ¼å¼çš„ URL ä¸­æå– ID
      // æ ¼å¼1: https://docs.google.com/spreadsheets/d/ID/edit...
      // æ ¼å¼2: https://docs.google.com/spreadsheets/d/ID/gviz/...
      // æ ¼å¼3: https://docs.google.com/spreadsheets/d/e/ID/pub...
      const match = url.match(/\/spreadsheets\/d\/(?:e\/)?([a-zA-Z0-9-_]+)/);
      if (match && match[1]) {
        const id = match[1].trim();
        console.log('æˆåŠŸæå– Spreadsheet ID:', id);
        return id;
      }
      
      console.warn('ç„¡æ³•å¾ URL ä¸­æå– Spreadsheet ID:', url);
      return null;
    }

    // 3. å¾ Google Spreadsheet åŠ è¼‰ç·´ç¿’æ¸…å–®ï¼ˆå·²å»¢æ£„ï¼‰
    // æ³¨æ„ï¼šæ­¤å‡½æ•¸å·²ä¸å†ä½¿ç”¨ã€‚ç·´ç¿’æ¸…å–®ç¾åœ¨åœ¨ç™»å…¥æ™‚é€šé verifyCourse æ“ä½œç²å–
    // é€™æ¨£å¯ä»¥ä¿è­· Spreadsheet URL ä¸è¢«æš´éœ²åœ¨å‰ç«¯ä»£ç¢¼ä¸­
    async function loadPracticesFromSheet() {
      console.warn('loadPracticesFromSheet å·²å»¢æ£„ã€‚ç·´ç¿’æ¸…å–®ç¾åœ¨åœ¨ç™»å…¥æ™‚é€šé Google Apps Script é©—è­‰å¾Œç²å–ã€‚');
      return;
    }

    // 4. ç›´æ¥å¾ CSV è®€å–ç·´ç¿’æ¸…å–®ï¼ˆå·²å»¢æ£„ï¼Œä¸å†ä½¿ç”¨ï¼‰
    // æ³¨æ„ï¼šæ­¤å‡½æ•¸å·²ä¸å†ä½¿ç”¨ã€‚æ‰€æœ‰æ•¸æ“šç¾åœ¨éƒ½é€šé Google Apps Script é©—è­‰å¾Œç²å–
    async function loadPracticesFromCsv() {
      console.warn('loadPracticesFromCsv å·²å»¢æ£„ã€‚ç·´ç¿’æ¸…å–®ç¾åœ¨åœ¨ç™»å…¥æ™‚é€šé Google Apps Script é©—è­‰å¾Œç²å–ã€‚');
      return;
    }

    // æ¸¬è©¦èª²ç¨‹é©—è­‰ï¼ˆå¯åœ¨æ§åˆ¶å°èª¿ç”¨ï¼‰
    // ç”¨æ³•ï¼štestCourseVerification('CS101', 'password123')
    window.testCourseVerification = async function(courseCode, password) {
      console.log('é–‹å§‹æ¸¬è©¦èª²ç¨‹é©—è­‰...');
      
      if (!GOOGLE_APPS_SCRIPT_URL) {
        console.error('âŒ GOOGLE_APPS_SCRIPT_URL æœªè¨­ç½®');
        return;
      }
      
      if (!courseCode || !password) {
        console.error('âŒ è«‹æä¾›èª²ç¨‹ç·¨è™Ÿå’Œå¯†ç¢¼');
        console.log('ç”¨æ³•ï¼štestCourseVerification("CS101", "password123")');
        return;
      }
      
      console.log('âœ… èª²ç¨‹ç·¨è™Ÿ:', courseCode);
      console.log('âœ… ä¼ºæœå™¨é€£æ¥:', GOOGLE_APPS_SCRIPT_URL);
      
      // ä½¿ç”¨ URLSearchParams æ§‹å»º URL
      const urlParams = new URLSearchParams({
        action: 'verifyCourse',
        courseCode: courseCode,
        password: password
      });
      const testUrl = `${GOOGLE_APPS_SCRIPT_URL}?${urlParams.toString()}`;
      console.log('æ¸¬è©¦ URL:', testUrl);
      console.log('URL åƒæ•¸:', urlParams.toString());
      
      try {
        const response = await fetch(testUrl, {
          method: 'GET',
          mode: 'cors',
          cache: 'no-cache'
        });
        console.log('éŸ¿æ‡‰ç‹€æ…‹:', response.status, response.statusText);
        
        const text = await response.text();
        console.log('éŸ¿æ‡‰å…§å®¹:', text);
        
        try {
          const data = JSON.parse(text);
          console.log('è§£æå¾Œçš„æ•¸æ“š:', data);
          
          if (data.success) {
            console.log('âœ… é©—è­‰æˆåŠŸï¼æ‰¾åˆ°', data.practices?.length || 0, 'å€‹ç·´ç¿’');
            console.log('ç·´ç¿’åˆ—è¡¨:', data.practices);
          } else {
            console.error('âŒ é©—è­‰å¤±æ•—:', data.error);
            if (data.expiryDate) {
              console.error('éæœŸæ—¥æœŸ:', data.expiryDate);
            }
          }
        } catch (jsonError) {
          console.error('âŒ ç„¡æ³•è§£æ JSON éŸ¿æ‡‰:', jsonError);
          console.error('åŸå§‹éŸ¿æ‡‰:', text);
        }
      } catch (error) {
        console.error('âŒ è«‹æ±‚å¤±æ•—:', error);
      }
    };

    // 3. åˆå§‹åŒ–æ‡‰ç”¨
    async function init() {
      hideAllScreens();
      
      // æª¢æŸ¥æ˜¯å¦å·²ç™»å…¥ï¼ˆä½¿ç”¨ sessionStorageï¼Œé—œé–‰ç€è¦½å™¨å¾Œå¤±æ•ˆï¼‰
      if (isLoggedIn()) {
        const courseCode = getCurrentCourseCode();
        
        if (courseCode) {
          // å…ˆå˜—è©¦å¾ sessionStorage æ¢å¾©ç·´ç¿’æ¸…å–®ï¼ˆå¿«é€Ÿé¡¯ç¤ºï¼‰
          const storedPractices = loadPracticesFromStorage(courseCode);
          
          if (storedPractices && storedPractices.length > 0) {
            // å…ˆä½¿ç”¨ç·©å­˜çš„ç·´ç¿’æ¸…å–®
            PRACTICES = storedPractices;
            console.log('å·²å¾ sessionStorage æ¢å¾©ç·´ç¿’æ¸…å–®ï¼Œå…±', PRACTICES.length, 'å€‹ç·´ç¿’');
            
            // æ³¨æ„ï¼šç¾åœ¨æ”¯æŒå¤šå€‹ç·´ç¿’åŒæ™‚é€²è¡Œï¼Œæ‰€ä»¥ä¸åœ¨ init æ™‚è‡ªå‹•æ¢å¾©
            // é€²åº¦æœƒåœ¨ç·´ç¿’é¸æ“‡é é¢é¡¯ç¤ºï¼Œå­¸ç”Ÿå¯ä»¥é¸æ“‡ç¹¼çºŒå“ªå€‹ç·´ç¿’
            
            // æ²’æœ‰æœªå®Œæˆçš„ç·´ç¿’ï¼Œé¡¯ç¤ºç·´ç¿’é¸æ“‡é é¢
            showPracticeSelect();
            
            // åœ¨å¾Œå°å˜—è©¦å¾æœå‹™å™¨ç²å–æœ€æ–°ç·´ç¿’æ¸…å–®
            try {
              const latestPractices = await fetchPracticesFromServer(courseCode);
              
              // å¦‚æœè¿”å› nullï¼Œè¡¨ç¤ºæœå‹™å™¨ä¸æ”¯æŒæ­¤æ“ä½œï¼Œä½¿ç”¨ç·©å­˜
              if (latestPractices === null) {
                console.log('æœå‹™å™¨ä¸æ”¯æŒ getPractices æ“ä½œï¼Œç¹¼çºŒä½¿ç”¨ç·©å­˜ç‰ˆæœ¬');
                return;
              }
              
              // æª¢æŸ¥æ˜¯å¦æœ‰æ›´æ–°ï¼ˆæ¯”è¼ƒç·´ç¿’æ•¸é‡æˆ– IDï¼‰
              const hasUpdate = JSON.stringify(latestPractices) !== JSON.stringify(storedPractices);
              
              if (hasUpdate) {
                // æœ‰æ›´æ–°ï¼Œä½¿ç”¨æœ€æ–°åˆ—è¡¨
                PRACTICES = latestPractices;
                savePracticesToStorage(PRACTICES, courseCode);
                console.log('ç·´ç¿’æ¸…å–®å·²æ›´æ–°ï¼Œå…±', PRACTICES.length, 'å€‹ç·´ç¿’');
                
                // é‡æ–°é¡¯ç¤ºç·´ç¿’é¸æ“‡ç•«é¢ä»¥åæ˜ æ›´æ–°
                showPracticeSelect();
              } else {
                console.log('ç·´ç¿’æ¸…å–®ç„¡æ›´æ–°');
              }
            } catch (error) {
              // ç²å–å¤±æ•—ï¼Œç¹¼çºŒä½¿ç”¨ç·©å­˜çš„åˆ—è¡¨
              console.warn('ç„¡æ³•å¾æœå‹™å™¨ç²å–æœ€æ–°ç·´ç¿’æ¸…å–®ï¼Œä½¿ç”¨ç·©å­˜ç‰ˆæœ¬:', error.message);
            }
          } else {
            // ç„¡æ³•å¾ sessionStorage æ¢å¾©ï¼Œå˜—è©¦å¾æœå‹™å™¨ç²å–
            try {
              const practices = await fetchPracticesFromServer(courseCode);
              
              // å¦‚æœè¿”å› nullï¼Œè¡¨ç¤ºæœå‹™å™¨ä¸æ”¯æŒæ­¤æ“ä½œï¼Œéœ€è¦é‡æ–°ç™»å…¥
              if (practices === null) {
                console.warn('æœå‹™å™¨ä¸æ”¯æŒ getPractices æ“ä½œï¼Œéœ€è¦é‡æ–°ç™»å…¥');
                clearLogin();
                showPasswordLogin();
                return;
              }
              
              PRACTICES = practices;
              savePracticesToStorage(PRACTICES, courseCode);
              console.log('å¾æœå‹™å™¨ç²å–ç·´ç¿’æ¸…å–®ï¼Œå…±', PRACTICES.length, 'å€‹ç·´ç¿’');
              
              // æ³¨æ„ï¼šç¾åœ¨æ”¯æŒå¤šå€‹ç·´ç¿’åŒæ™‚é€²è¡Œï¼Œæ‰€ä»¥ä¸åœ¨ init æ™‚è‡ªå‹•æ¢å¾©
              // é€²åº¦æœƒåœ¨ç·´ç¿’é¸æ“‡é é¢é¡¯ç¤ºï¼Œå­¸ç”Ÿå¯ä»¥é¸æ“‡ç¹¼çºŒå“ªå€‹ç·´ç¿’
              
              showPracticeSelect();
            } catch (error) {
              // ç²å–å¤±æ•—ï¼Œæ¸…é™¤ç™»å…¥ç‹€æ…‹ï¼Œè¦æ±‚é‡æ–°ç™»å…¥
              console.error('ç„¡æ³•ç²å–ç·´ç¿’æ¸…å–®ï¼Œéœ€è¦é‡æ–°ç™»å…¥:', error.message);
              clearLogin();
              showPasswordLogin();
            }
          }
        } else {
          // æ²’æœ‰èª²ç¨‹ç·¨è™Ÿï¼Œæ¸…é™¤ç™»å…¥ç‹€æ…‹
          clearLogin();
          showPasswordLogin();
        }
      } else {
        showPasswordLogin();
      }
    }

    // é¡¯ç¤ºå¯†ç¢¼ç™»å…¥ç•«é¢
    function showPasswordLogin() {
      hideAllScreens();
      disableContentProtection();
      removeWatermark();
      passwordLoginScreen.classList.remove('hidden');
      document.getElementById('login-error').innerText = '';
      document.getElementById('login-course-code-input').value = '';
      document.getElementById('login-password-input').value = '';
      
      // è¨­ç½® Enter éµäº‹ä»¶
      const loginCourseCodeInput = document.getElementById('login-course-code-input');
      const loginPasswordInput = document.getElementById('login-password-input');
      
      // ç§»é™¤èˆŠçš„äº‹ä»¶ç›£è½å™¨
      const newCourseCodeInput = loginCourseCodeInput.cloneNode(true);
      loginCourseCodeInput.parentNode.replaceChild(newCourseCodeInput, loginCourseCodeInput);
      const newPasswordInput = loginPasswordInput.cloneNode(true);
      loginPasswordInput.parentNode.replaceChild(newPasswordInput, loginPasswordInput);
      
      // èª²ç¨‹ç·¨è™Ÿè¼¸å…¥æ¡†ï¼šæŒ‰ Enter è·³åˆ°å¯†ç¢¼è¼¸å…¥æ¡†
      document.getElementById('login-course-code-input').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          document.getElementById('login-password-input').focus();
        }
      });
      
      // å¯†ç¢¼è¼¸å…¥æ¡†ï¼šæŒ‰ Enter åŸ·è¡Œç™»å…¥
      document.getElementById('login-password-input').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          login();
        }
      });
      
      // è‡ªå‹•èšç„¦åˆ°èª²ç¨‹ç·¨è™Ÿè¼¸å…¥æ¡†
      setTimeout(() => {
        document.getElementById('login-course-code-input').focus();
      }, 100);
    }

    // 3. è¼‰å…¥é¡Œç›®ï¼ˆæ–°ç·´ç¿’ï¼‰
    async function loadQuestions(csvUrl) {
      try {
        // æ³¨æ„ï¼šä¸æ¸…é™¤å…¶ä»–ç·´ç¿’çš„é€²åº¦ï¼Œå› ç‚ºå¯èƒ½æœ‰å¤šå€‹ç·´ç¿’åŒæ™‚é€²è¡Œ
        // åªä¿å­˜ç•¶å‰ç·´ç¿’çš„é€²åº¦
        
        // æª¢æŸ¥æ˜¯å¦ä½¿ç”¨ç¯„ä¾‹ URL
        if (csvUrl.includes("2PACX-1vR6y2w2J2tO_k-X8tXQy3z5oP5o5z5o5z5o5z5o")) {
           // æ¨¡æ“¬è³‡æ–™
           questions = [
             { id: 1, question: "ï¼ˆç¤ºç¯„é¡Œï¼‰è«‹æ›´æ›ç·´ç¿’é…ç½®ä¸­çš„ CSV é€£çµ", options: ["å¥½", "ä¸å¥½", "é€£çµåœ¨å“ª?", "ç•¥é"], correctAnswer: 0, explanation: "è«‹åœ¨ PRACTICES é™£åˆ—ä¸­æ›´æ–° CSV é€£çµã€‚" },
             { id: 2, question: "ï¼ˆç¤ºç¯„é¡Œï¼‰Ionic æ˜¯ä»€éº¼ï¼Ÿ", options: ["è³‡æ–™åº«", "UI Framework", "å¾Œç«¯èªè¨€", "ä½œæ¥­ç³»çµ±"], correctAnswer: 1, explanation: "Ionic æ˜¯ä¸€å€‹ç”¨æ–¼å»ºç«‹è·¨å¹³å° App çš„ UI Frameworkã€‚" }
           ];
        } else {
          const response = await fetch(csvUrl);
          if (!response.ok) throw new Error("ç¶²è·¯è«‹æ±‚å¤±æ•—");
          const csvText = await response.text();
          const parsedRows = parseCSV(csvText);
          const dataRows = parsedRows.slice(1); // å»é™¤æ¨™é¡Œ

          questions = dataRows
            .filter(row => {
              // è‡³å°‘éœ€è¦é¡Œç›®å’Œé¸é …
              const hasQuestion = row[0] && row[0].trim().length > 0;
              const hasOptions = row[1] && row[1].trim().length > 0;
              return hasQuestion && hasOptions;
            })
            .map((row, index) => {
              // è§£æé¸é …ï¼šæ”¯æŒå¤šç¨®æ ¼å¼
              let options = [];
              let parseMethod = '';
              
              // æ ¼å¼1ï¼šé¸é …å­˜å„²åœ¨ä¸€å€‹å–®å…ƒæ ¼ä¸­ï¼Œç”¨åˆ†éš”ç¬¦åˆ†éš”ï¼ˆæ¨è–¦ï¼‰
              // æ”¯æŒçš„åˆ†éš”ç¬¦ï¼š| æˆ– ; æˆ– || æˆ– ;;
              if (row[1] && (row[1].includes('|') || row[1].includes(';'))) {
                // ä½¿ç”¨åˆ†éš”ç¬¦æ‹†åˆ†é¸é …
                const separator = row[1].includes('||') ? '||' : 
                                 row[1].includes(';;') ? ';;' :
                                 row[1].includes('|') ? '|' : ';';
                options = row[1].split(separator).map(opt => opt.trim()).filter(opt => opt.length > 0);
                parseMethod = `åˆ†éš”ç¬¦æ ¼å¼ (${separator})`;
              } 
              // æ ¼å¼2ï¼šé¸é …åˆ†åˆ¥å­˜å„²åœ¨ä¸åŒåˆ—ä¸­ï¼ˆå‘å¾Œå…¼å®¹ï¼‰
              else if (row.length >= 7 && row[1] && row[2] && row[3] && row[4]) {
                options = [row[1], row[2], row[3], row[4]].filter(opt => opt && opt.trim().length > 0);
                parseMethod = 'å¤šåˆ—æ ¼å¼';
              }
              // æ ¼å¼3ï¼šåªæœ‰ä¸€å€‹é¸é …åˆ—ï¼Œå˜—è©¦ç”¨å…¶ä»–åˆ†éš”ç¬¦
              else if (row[1]) {
                // å˜—è©¦ç”¨æ›è¡Œç¬¦æˆ–å…¶ä»–å­—ç¬¦åˆ†éš”
                options = row[1].split(/\n|\r\n|\\n/).map(opt => opt.trim()).filter(opt => opt.length > 0);
                if (options.length > 1) {
                  parseMethod = 'æ›è¡Œç¬¦æ ¼å¼';
                } else if (options.length === 1 && row[1].includes(',')) {
                  // å¦‚æœé‚„æ˜¯åªæœ‰ä¸€å€‹ï¼Œå˜—è©¦ç”¨é€—è™Ÿåˆ†éš”
                  options = row[1].split(',').map(opt => opt.trim()).filter(opt => opt.length > 0);
                  parseMethod = 'é€—è™Ÿåˆ†éš”æ ¼å¼';
                } else {
                  // å¦‚æœåªæœ‰ä¸€å€‹é¸é …ï¼Œå°‡å…¶ä½œç‚ºå–®ä¸€é¸é …
                  options = [row[1].trim()];
                  parseMethod = 'å–®ä¸€é¸é …æ ¼å¼';
                }
              }
              
              // å¦‚æœé‚„æ˜¯æ²’æœ‰é¸é …ï¼Œä½¿ç”¨é»˜èªå€¼
              if (options.length === 0) {
                console.warn(`ç¬¬ ${index + 2} è¡Œï¼šç„¡æ³•è§£æé¸é …ï¼Œä½¿ç”¨é»˜èªå€¼`, row);
                options = ['é¸é …A', 'é¸é …B', 'é¸é …C', 'é¸é …D'];
                parseMethod = 'é»˜èªå€¼';
              }
              
              // èª¿è©¦ä¿¡æ¯ï¼ˆåƒ…åœ¨é–‹ç™¼ç’°å¢ƒé¡¯ç¤ºï¼‰
              if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1' || window.location.protocol === 'file:') {
                console.log(`é¡Œç›® ${index + 1}: è§£ææ–¹æ³•=${parseMethod}, é¸é …æ•¸é‡=${options.length}`, options);
              }
              
              // è§£ææ­£ç¢ºç­”æ¡ˆ
              // æ”¯æŒ 1-basedï¼ˆ1,2,3,4ï¼‰æˆ– 0-basedï¼ˆ0,1,2,3ï¼‰
              let correctAnswer = 0;
              if (row.length >= 3 && row[2]) {
                const answerValue = parseInt(row[2]);
                if (!isNaN(answerValue)) {
                  // å¦‚æœç­”æ¡ˆ >= 1ï¼Œå‡è¨­æ˜¯ 1-basedï¼Œéœ€è¦è½‰æ›ç‚º 0-based
                  // å¦‚æœç­”æ¡ˆ = 0ï¼Œå‡è¨­å·²ç¶“æ˜¯ 0-based
                  correctAnswer = answerValue >= 1 ? answerValue - 1 : answerValue;
                }
              } else if (row.length >= 6 && row[5]) {
                // å‘å¾Œå…¼å®¹ï¼šå¦‚æœç¬¬6åˆ—æœ‰å€¼ï¼Œä½¿ç”¨å®ƒ
                const answerValue = parseInt(row[5]);
                if (!isNaN(answerValue)) {
                  correctAnswer = answerValue >= 1 ? answerValue - 1 : answerValue;
                }
              }
              
              // ç¢ºä¿æ­£ç¢ºç­”æ¡ˆåœ¨æœ‰æ•ˆç¯„åœå…§
              if (correctAnswer < 0 || correctAnswer >= options.length) {
                correctAnswer = 0;
              }
              
              // è§£æè§£é‡‹ï¼ˆå¯é¸ï¼‰
              let explanation = '';
              if (row.length >= 4 && row[3]) {
                explanation = row[3].trim();
              } else if (row.length >= 7 && row[6]) {
                // å‘å¾Œå…¼å®¹ï¼šå¦‚æœç¬¬7åˆ—æœ‰å€¼ï¼Œä½¿ç”¨å®ƒ
                explanation = row[6].trim();
              }
              
              return {
                id: index + 1,
                question: (row[0] || '').trim(),
                options: options,
                correctAnswer: correctAnswer,
                explanation: explanation
              };
            })
            .filter(q => q.question && q.question.length > 0); // éæ¿¾æ‰æ²’æœ‰é¡Œç›®çš„è¡Œ
        }

        if (questions.length === 0) throw new Error("æ²’æœ‰é¡Œç›®è³‡æ–™");

        loadingScreen.classList.add('hidden');
        quizScreen.classList.remove('hidden');
        
        // ç¢ºä¿å®¹å™¨å……åˆ†åˆ©ç”¨å¯¬åº¦
        const quizContainer = document.querySelector('.quiz-container');
        if (quizContainer) {
          quizContainer.style.maxWidth = '100%';
          quizContainer.style.width = '100%';
          quizContainer.style.padding = '0';
        }
        
        // æ›´æ–°ç·´ç¿’åç¨±
        const practiceNameDisplay = document.getElementById('practice-name-display');
        if (practiceNameDisplay && currentPractice) {
          practiceNameDisplay.textContent = currentPractice.name;
        }
        
        // å•Ÿç”¨å…§å®¹ä¿è­·
        enableContentProtection();
        addWatermark('åƒ…ä¾›æˆæ¬Šå­¸ç”Ÿä½¿ç”¨ - ç¦æ­¢è¤‡è£½æˆ–åˆ†äº«');
        renderQuestion(); // renderQuestion å…§éƒ¨æœƒèª¿ç”¨ updateQuestionList()
        
        // ä¿å­˜åˆå§‹é€²åº¦
        savePracticeProgress();

      } catch (err) {
        loadingScreen.classList.add('hidden');
        errorScreen.classList.remove('hidden');
        document.getElementById('error-message').innerText = err.message + " (è«‹æª¢æŸ¥ CSV é€£çµ)";
      }
    }

    // è¼‰å…¥é¡Œç›®ä¸¦æ¢å¾©é€²åº¦
    async function loadQuestionsAndResume(csvUrl) {
      try {
        // ä½¿ç”¨ç•¶å‰ç·´ç¿’å’Œå­¸ç”Ÿå§“åç²å–é€²åº¦
        const progress = loadPracticeProgress(currentPractice.id, currentStudentName);
        if (!progress) {
          // æ²’æœ‰é€²åº¦ï¼Œæ­£å¸¸è¼‰å…¥
          await loadQuestions(csvUrl);
          return;
        }

        // è¼‰å…¥é¡Œç›®ï¼ˆèˆ‡ loadQuestions ç›¸åŒçš„é‚è¼¯ï¼‰
        if (csvUrl.includes("2PACX-1vR6y2w2J2tO_k-X8tXQy3z5oP5o5z5o5z5o5z5o")) {
           questions = [
             { id: 1, question: "ï¼ˆç¤ºç¯„é¡Œï¼‰è«‹æ›´æ›ç·´ç¿’é…ç½®ä¸­çš„ CSV é€£çµ", options: ["å¥½", "ä¸å¥½", "é€£çµåœ¨å“ª?", "ç•¥é"], correctAnswer: 0, explanation: "è«‹åœ¨ PRACTICES é™£åˆ—ä¸­æ›´æ–° CSV é€£çµã€‚" },
             { id: 2, question: "ï¼ˆç¤ºç¯„é¡Œï¼‰Ionic æ˜¯ä»€éº¼ï¼Ÿ", options: ["è³‡æ–™åº«", "UI Framework", "å¾Œç«¯èªè¨€", "ä½œæ¥­ç³»çµ±"], correctAnswer: 1, explanation: "Ionic æ˜¯ä¸€å€‹ç”¨æ–¼å»ºç«‹è·¨å¹³å° App çš„ UI Frameworkã€‚" }
           ];
        } else {
          const response = await fetch(csvUrl);
          if (!response.ok) throw new Error("ç¶²è·¯è«‹æ±‚å¤±æ•—");
          const csvText = await response.text();
          const parsedRows = parseCSV(csvText);
          const dataRows = parsedRows.slice(1);

          questions = dataRows
            .filter(row => {
              const hasQuestion = row[0] && row[0].trim().length > 0;
              const hasOptions = row[1] && row[1].trim().length > 0;
              return hasQuestion && hasOptions;
            })
            .map((row, index) => {
              let options = [];
              
              if (row[1] && (row[1].includes('|') || row[1].includes(';'))) {
                const separator = row[1].includes('||') ? '||' : 
                                 row[1].includes(';;') ? ';;' :
                                 row[1].includes('|') ? '|' : ';';
                options = row[1].split(separator).map(opt => opt.trim()).filter(opt => opt.length > 0);
              } else if (row.length >= 7 && row[1] && row[2] && row[3] && row[4]) {
                options = [row[1], row[2], row[3], row[4]].filter(opt => opt && opt.trim().length > 0);
              } else if (row[1]) {
                options = row[1].split(/\n|\r\n|\\n/).map(opt => opt.trim()).filter(opt => opt.length > 0);
                if (options.length === 1 && row[1].includes(',')) {
                  options = row[1].split(',').map(opt => opt.trim()).filter(opt => opt.length > 0);
                }
              }
              
              if (options.length === 0) {
                options = ['é¸é …A', 'é¸é …B', 'é¸é …C', 'é¸é …D'];
              }
              
              let correctAnswer = 0;
              if (row.length >= 3 && row[2]) {
                const answerValue = parseInt(row[2]);
                if (!isNaN(answerValue)) {
                  correctAnswer = answerValue >= 1 ? answerValue - 1 : answerValue;
                }
              } else if (row.length >= 6 && row[5]) {
                const answerValue = parseInt(row[5]);
                if (!isNaN(answerValue)) {
                  correctAnswer = answerValue >= 1 ? answerValue - 1 : answerValue;
                }
              }
              
              if (correctAnswer < 0 || correctAnswer >= options.length) {
                correctAnswer = 0;
              }
              
              let explanation = '';
              if (row.length >= 4 && row[3]) {
                explanation = row[3].trim();
              } else if (row.length >= 7 && row[6]) {
                explanation = row[6].trim();
              }
              
              return {
                id: index + 1,
                question: (row[0] || '').trim(),
                options: options,
                correctAnswer: correctAnswer,
                explanation: explanation
              };
            })
            .filter(q => q.question && q.question.length > 0);
        }

        if (questions.length === 0) throw new Error("æ²’æœ‰é¡Œç›®è³‡æ–™");

        // æ¢å¾©é€²åº¦ï¼ˆç¢ºä¿ä½¿ç”¨é€²åº¦ä¸­çš„æ•¸æ“šï¼Œè€Œä¸æ˜¯å…¨å±€è®Šé‡ï¼‰
        if (progress) {
          currentQIndex = progress.currentQIndex || 0;
          historyData = progress.historyData || [];
          score = progress.score || 0;
          // ç¢ºä¿å­¸ç”Ÿå§“åæ­£ç¢º
          if (progress.studentName && !currentStudentName) {
            currentStudentName = progress.studentName;
          }
        }

        loadingScreen.classList.add('hidden');
        quizScreen.classList.remove('hidden');
        
        // ç¢ºä¿å®¹å™¨å……åˆ†åˆ©ç”¨å¯¬åº¦
        const quizContainer = document.querySelector('.quiz-container');
        if (quizContainer) {
          quizContainer.style.maxWidth = '100%';
          quizContainer.style.width = '100%';
          quizContainer.style.padding = '0';
        }
        
        // æ›´æ–°ç·´ç¿’åç¨±
        const practiceNameDisplay = document.getElementById('practice-name-display');
        if (practiceNameDisplay && currentPractice) {
          practiceNameDisplay.textContent = currentPractice.name;
        }
        
        enableContentProtection();
        addWatermark('åƒ…ä¾›æˆæ¬Šå­¸ç”Ÿä½¿ç”¨ - ç¦æ­¢è¤‡è£½æˆ–åˆ†äº«');
        renderQuestion();
        
        // ä¿å­˜é€²åº¦
        savePracticeProgress();

      } catch (err) {
        loadingScreen.classList.add('hidden');
        errorScreen.classList.remove('hidden');
        document.getElementById('error-message').innerText = err.message + " (è«‹æª¢æŸ¥ CSV é€£çµ)";
      }
    }

    // æ›´æ–°é¡Œç›®ç›®éŒ„
    function updateQuestionList() {
      const questionList = document.getElementById('question-list');
      if (!questionList) return;

      questionList.innerHTML = '';
      
      questions.forEach((q, index) => {
        const item = document.createElement('div');
        item.className = 'question-item';
        
        // æª¢æŸ¥é€™é¡Œæ˜¯å¦å·²ç¶“ç­”é
        const answeredHistory = historyData.find(h => h.question === q.question);
        const isCurrent = index === currentQIndex;
        const isAnswered = !!answeredHistory;
        const isCorrect = answeredHistory ? answeredHistory.isCorrect : false;
        
        // è¨­ç½®æ¨£å¼é¡
        if (isCurrent) {
          item.classList.add('current');
        }
        if (isAnswered) {
          item.classList.add('answered');
          if (!isCorrect) {
            item.classList.add('wrong');
          }
        }
        
        // é¡Œç›®ç·¨è™Ÿå’Œç‹€æ…‹
        let statusIcon = '';
        if (isAnswered) {
          statusIcon = isCorrect ? ' âœ“' : ' âœ—';
        }
        
        item.innerHTML = `
          <div style="display: flex; align-items: center;">
            <span class="question-item-number">${index + 1}.</span>
            <span style="flex: 1; font-size: 0.9em;">é¡Œç›® ${index + 1}${statusIcon}</span>
          </div>
        `;
        
        // é»æ“Šè·³è½‰åˆ°è©²é¡Œç›®
        item.onclick = () => {
          if (index !== currentQIndex) {
            // ä¿å­˜ç•¶å‰é€²åº¦
            savePracticeProgress();
            // é—œé–‰èœå–®ï¼ˆå¦‚æœæ˜¯æ‰‹æ©Ÿç‰ˆï¼‰
            closeQuizMenu();
            // è·³è½‰åˆ°é¸ä¸­çš„é¡Œç›®
            currentQIndex = index;
            renderQuestion();
          }
        };
        
        questionList.appendChild(item);
      });
    }

    // 4. æ¸²æŸ“é¡Œç›®
    function renderQuestion() {
      const currentQ = questions[currentQIndex];
      
      // æ›´æ–°ç·´ç¿’åç¨±
      const practiceNameDisplay = document.getElementById('practice-name-display');
      if (practiceNameDisplay && currentPractice) {
        practiceNameDisplay.textContent = currentPractice.name;
      }
      
      // æ›´æ–° UI ç‹€æ…‹
      qCurrentEl.innerText = currentQIndex + 1;
      qTotalEl.innerText = questions.length;
      progressBar.value = (currentQIndex + 1) / questions.length;
      
      // ç¢ºä¿å•é¡Œæ–‡å­—å§‹çµ‚é¡¯ç¤ºä¸”å®Œæ•´
      questionText.innerText = currentQ.question;
      questionText.style.display = 'block';
      questionText.style.visibility = 'visible';
      questionText.style.opacity = '1';
      
      // ç¢ºä¿å•é¡Œå¡ç‰‡å¯è¦‹
      const questionCard = questionText.closest('ion-card');
      if (questionCard) {
        questionCard.style.display = 'block';
        questionCard.style.visibility = 'visible';
        questionCard.style.opacity = '1';
      }
      
      // æ›´æ–°é¡Œç›®ç›®éŒ„
      updateQuestionList();
      
      // é‡ç½®æŒ‰éˆ•èˆ‡å›é¥‹å€
      submitBtn.classList.remove('hidden');
      submitBtn.disabled = true;
      nextBtn.classList.add('hidden');
      feedbackArea.classList.add('hidden');
      selectedOptionIndex = null;
      isAnswered = false;

      // æª¢æŸ¥é€™é¡Œæ˜¯å¦å·²ç¶“ç­”éï¼ˆæ¢å¾©é€²åº¦æ™‚ï¼‰
      const answeredHistory = historyData.find(h => {
        // é€šéé¡Œç›®å…§å®¹åŒ¹é…ï¼ˆå› ç‚ºé¡Œç›®IDå¯èƒ½ä¸ç©©å®šï¼‰
        return h.question === currentQ.question;
      });

      // ç”¢ç”Ÿé¸é …
      optionsContainer.innerHTML = '';
      currentQ.options.forEach((opt, idx) => {
        const card = document.createElement('ion-card');
        card.className = 'option-card ion-padding';
        
        // å¦‚æœé€™é¡Œå·²ç¶“ç­”éï¼Œé¡¯ç¤ºä¹‹å‰çš„ç­”æ¡ˆç‹€æ…‹
        if (answeredHistory) {
          const wasSelected = answeredHistory.userSelect === opt;
          const isCorrect = opt === answeredHistory.correctSelect;
          
          if (isCorrect) {
            card.classList.add('correct');
          } else if (wasSelected && !isCorrect) {
            card.classList.add('wrong');
          }
        }
        
        // å®‰å…¨åœ°å‰µå»ºé¸é …å¡ç‰‡ï¼ˆé˜²æ­¢ XSSï¼‰
        const optDiv = document.createElement('div');
        optDiv.style.display = 'flex';
        optDiv.style.alignItems = 'center';
        const optInnerDiv = document.createElement('div');
        optInnerDiv.style.flex = '1';
        optInnerDiv.style.fontWeight = '500';
        optInnerDiv.textContent = escapeHtml(opt || '');
        optDiv.appendChild(optInnerDiv);
        card.appendChild(optDiv);
        
        if (!answeredHistory) {
          card.onclick = () => selectOption(idx, card);
        } else {
          // å·²ç­”éçš„é¡Œç›®ï¼Œé¡¯ç¤ºç‚ºåªè®€
          card.style.opacity = '0.8';
          card.style.cursor = 'default';
        }
        
        optionsContainer.appendChild(card);
      });

      // å¦‚æœé€™é¡Œå·²ç¶“ç­”éï¼Œé¡¯ç¤ºè§£æ
      if (answeredHistory) {
        isAnswered = true;
        submitBtn.classList.add('hidden');
        nextBtn.classList.remove('hidden');
        
        // ç¢ºä¿å•é¡Œæ–‡å­—ä»ç„¶å¯è¦‹
        questionText.style.display = 'block';
        questionText.style.visibility = 'visible';
        questionText.style.opacity = '1';
        const questionCard = questionText.closest('ion-card');
        if (questionCard) {
          questionCard.style.display = 'block';
          questionCard.style.visibility = 'visible';
          questionCard.style.opacity = '1';
        }
        
        feedbackArea.classList.remove('hidden');
        feedbackArea.style.display = 'block'; // ç¢ºä¿é¡¯ç¤º
        
        if (answeredHistory.isCorrect) {
          feedbackArea.style.borderColor = 'var(--ion-color-success)';
          feedbackArea.style.backgroundColor = '#f0fdf4';
          feedbackTitle.innerText = "å›ç­”æ­£ç¢º";
          feedbackTitle.style.color = 'var(--ion-color-success)';
          feedbackIcon.name = "checkmark-circle";
          feedbackIcon.color = "success";
        } else {
          feedbackArea.style.borderColor = 'var(--ion-color-danger)';
          feedbackArea.style.backgroundColor = '#fef2f2';
          feedbackTitle.innerText = "å›ç­”éŒ¯èª¤";
          feedbackTitle.style.color = 'var(--ion-color-danger)';
          feedbackIcon.name = "close-circle";
          feedbackIcon.color = "danger";
        }
        
        // ç¢ºä¿è§£é‡‹æ–‡æœ¬æœ‰å…§å®¹
        const explanation = answeredHistory.explanation || currentQ.explanation || 'ï¼ˆæ­¤é¡Œç›®æš«ç„¡è©³ç´°è§£é‡‹ï¼‰';
        feedbackText.innerText = explanation;
        feedbackText.style.display = 'block'; // ç¢ºä¿æ–‡æœ¬é¡¯ç¤º
        
        // ç¢ºä¿åé¥‹å€åŸŸå¯è¦‹
        feedbackArea.style.visibility = 'visible';
        feedbackArea.style.opacity = '1';
        
        // å¦‚æœæ˜¯æœ€å¾Œä¸€é¡Œï¼Œæ”¹æŒ‰éˆ•æ–‡å­—
        if (currentQIndex === questions.length - 1) {
          nextBtn.innerHTML = 'æŸ¥çœ‹æˆç¸¾ <ion-icon slot="end" name="trophy"></ion-icon>';
        }
      }
      
      // ä¿å­˜é€²åº¦
      savePracticeProgress();
    }

    // 5. é¸æ“‡é¸é …
    function selectOption(index, cardElement) {
      if (isAnswered) return;

      selectedOptionIndex = index;
      submitBtn.disabled = false;

      // ç§»é™¤å…¶ä»–é¸é …çš„ selected æ¨£å¼
      document.querySelectorAll('.option-card').forEach(el => el.classList.remove('selected'));
      // åŠ å…¥ç•¶å‰é¸é …æ¨£å¼
      cardElement.classList.add('selected');
    }

    // 6. æäº¤ç­”æ¡ˆ
    submitBtn.addEventListener('click', () => {
      if (selectedOptionIndex === null) return;
      
      isAnswered = true;
      const currentQ = questions[currentQIndex];
      const isCorrect = selectedOptionIndex === currentQ.correctAnswer;
      const cards = document.querySelectorAll('.option-card');

      // è¨ˆç®—åˆ†æ•¸
      if (isCorrect) score += (100 / questions.length);

      // ç´€éŒ„æ­·å²
      historyData.push({
        question: currentQ.question,
        userSelect: currentQ.options[selectedOptionIndex],
        correctSelect: currentQ.options[currentQ.correctAnswer],
        isCorrect: isCorrect,
        explanation: currentQ.explanation
      });

      // é¡¯ç¤ºæ­£ç¢º/éŒ¯èª¤æ¨£å¼
      cards[currentQ.correctAnswer].classList.add('correct'); // æ¨™è¨˜æ­£è§£
      // å¦‚æœé¸éŒ¯äº†ï¼Œæ¨™è¨˜éŒ¯èª¤
      if (!isCorrect) {
        cards[selectedOptionIndex].classList.add('wrong');
      }

      // ç¢ºä¿å•é¡Œæ–‡å­—ä»ç„¶å¯è¦‹
      questionText.style.display = 'block';
      questionText.style.visibility = 'visible';
      questionText.style.opacity = '1';
      const questionCard = questionText.closest('ion-card');
      if (questionCard) {
        questionCard.style.display = 'block';
        questionCard.style.visibility = 'visible';
        questionCard.style.opacity = '1';
      }
      
      // é¡¯ç¤ºè§£æ
      feedbackArea.classList.remove('hidden');
      feedbackArea.style.display = 'block'; // ç¢ºä¿é¡¯ç¤º
      
      if (isCorrect) {
        feedbackArea.style.borderColor = 'var(--ion-color-success)';
        feedbackArea.style.backgroundColor = '#f0fdf4';
        feedbackTitle.innerText = "å›ç­”æ­£ç¢º";
        feedbackTitle.style.color = 'var(--ion-color-success)';
        feedbackIcon.name = "checkmark-circle";
        feedbackIcon.color = "success";
      } else {
        feedbackArea.style.borderColor = 'var(--ion-color-danger)';
        feedbackArea.style.backgroundColor = '#fef2f2';
        feedbackTitle.innerText = "å›ç­”éŒ¯èª¤";
        feedbackTitle.style.color = 'var(--ion-color-danger)';
        feedbackIcon.name = "close-circle";
        feedbackIcon.color = "danger";
      }
      
      // ç¢ºä¿è§£é‡‹æ–‡æœ¬æœ‰å…§å®¹
      const explanation = currentQ.explanation || 'ï¼ˆæ­¤é¡Œç›®æš«ç„¡è©³ç´°è§£é‡‹ï¼‰';
      feedbackText.innerText = explanation;
      feedbackText.style.display = 'block'; // ç¢ºä¿æ–‡æœ¬é¡¯ç¤º
      
      // ç¢ºä¿åé¥‹å€åŸŸå¯è¦‹
      feedbackArea.style.visibility = 'visible';
      feedbackArea.style.opacity = '1';

      // åˆ‡æ›æŒ‰éˆ•
      submitBtn.classList.add('hidden');
      nextBtn.classList.remove('hidden');
      
      // å¦‚æœæ˜¯æœ€å¾Œä¸€é¡Œï¼Œæ”¹æŒ‰éˆ•æ–‡å­—
      if (currentQIndex === questions.length - 1) {
        nextBtn.innerHTML = 'æŸ¥çœ‹æˆç¸¾ <ion-icon slot="end" name="trophy"></ion-icon>';
      }
      
      // æ›´æ–°é¡Œç›®ç›®éŒ„ï¼ˆé¡¯ç¤ºç­”é¡Œç‹€æ…‹ï¼‰
      updateQuestionList();
      
      // ä¿å­˜é€²åº¦ï¼ˆæäº¤ç­”æ¡ˆæ™‚è‡ªå‹•ä¿å­˜ï¼‰
      savePracticeProgress();
    });

    // 7. ä¸‹ä¸€é¡Œ
    nextBtn.addEventListener('click', () => {
      if (currentQIndex < questions.length - 1) {
        currentQIndex++;
        renderQuestion();
        // renderQuestion å…§éƒ¨æœƒèª¿ç”¨ savePracticeProgress
      } else {
        showResults();
      }
    });

    // 8. é¡¯ç¤ºçµæœ
    function showResults() {
      quizScreen.classList.add('hidden');
      resultScreen.classList.remove('hidden');
      // ä¿æŒå…§å®¹ä¿è­·
      enableContentProtection();
      addWatermark('åƒ…ä¾›æˆæ¬Šå­¸ç”Ÿä½¿ç”¨ - ç¦æ­¢è¤‡è£½æˆ–åˆ†äº«');

      const finalScore = Math.round(score);
      const isPassed = finalScore >= PASSING_SCORE;
      const scoreEl = document.getElementById('final-score');
      const resultMsg = document.getElementById('result-msg');
      const resultIcon = document.getElementById('result-icon');
      const studentNameDisplay = document.getElementById('student-name-display');

      // é¡¯ç¤ºå­¸ç”Ÿå§“å
      if (studentNameDisplay && currentStudentName) {
        studentNameDisplay.textContent = `å­¸ç”Ÿï¼š${currentStudentName}`;
      }

      // ä¿å­˜å¾—åˆ†
      if (currentStudentName && currentPractice) {
        const courseCode = getCurrentCourseCode();
        saveScore(
          currentStudentName,
          currentPractice.id,
          currentPractice.name,
          finalScore,
          courseCode
        );
      }

      // æ¸…é™¤ç•¶å‰ç·´ç¿’çš„é€²åº¦ï¼ˆå·²å®Œæˆï¼‰
      if (currentPractice && currentStudentName) {
        clearPracticeProgress(currentPractice.id, currentStudentName);
        console.log('å·²æ¸…é™¤å®Œæˆç·´ç¿’çš„é€²åº¦:', currentPractice.id, currentStudentName);
      }
      
      // æ³¨æ„ï¼šä¸æ¸…é™¤ currentPractice å’Œ currentStudentName è®Šé‡
      // å› ç‚ºè¿”å›æŒ‰éˆ•éœ€è¦çŸ¥é“æ˜¯å¾å“ªå€‹ç·´ç¿’è¿”å›çš„
      // ä½†æœƒåœ¨ backToPracticeSelect() ä¸­æ ¹æ“šæ˜¯å¦å¾çµæœç•«é¢è¿”å›ä¾†æ±ºå®šæ˜¯å¦æ¸…é™¤

      scoreEl.innerText = finalScore;
      scoreEl.style.color = isPassed ? 'var(--ion-color-success)' : 'var(--ion-color-danger)';
      
      if (isPassed) {
        resultMsg.innerText = "æ­å–œé€šéï¼";
        resultIcon.name = "trophy";
        resultIcon.color = "success";
      } else {
        resultMsg.innerText = `æœªé”æ¨™ (${PASSING_SCORE}åˆ†)ï¼Œè«‹å†æ¥å†å²ï¼`;
        resultIcon.name = "sad";
        resultIcon.color = "danger";
      }

      // ç”¢ç”Ÿæ­·å²åˆ—è¡¨
      const list = document.getElementById('history-list');
      list.innerHTML = '';
      historyData.forEach((h, idx) => {
        const item = document.createElement('ion-item');
        item.innerHTML = `
          <ion-icon name="${h.isCorrect ? 'checkmark-circle' : 'close-circle'}" slot="start" color="${h.isCorrect ? 'success' : 'danger'}"></ion-icon>
          <ion-label class="ion-text-wrap">
            <h2>Q${idx + 1}: ${escapeHtml(h.question || '')}</h2>
            ${!h.isCorrect ? `<p style="color:var(--ion-color-danger)">ä½ é¸äº†: ${escapeHtml(h.userSelect || '')}</p>` : ''}
            <p style="color:var(--ion-color-success)">æ­£è§£: ${escapeHtml(h.correctSelect || '')}</p>
            <p style="font-size:0.8em; color:#666; margin-top:4px;">${escapeHtml(h.explanation || 'ï¼ˆæ­¤é¡Œç›®æš«ç„¡è©³ç´°è§£é‡‹ï¼‰')}</p>
          </ion-label>
        `;
        list.appendChild(item);
      });
    }

    // 9. é‡æ–°é–‹å§‹
    window.restartQuiz = function() {
      // æ¸…é™¤ç•¶å‰ç·´ç¿’çš„é€²åº¦
      if (currentPractice && currentStudentName) {
        clearPracticeProgress(currentPractice.id, currentStudentName);
      }
      
      currentQIndex = 0;
      score = 0;
      historyData = [];
      resultScreen.classList.add('hidden');
      quizScreen.classList.remove('hidden');
      
      // ç¢ºä¿å®¹å™¨å……åˆ†åˆ©ç”¨å¯¬åº¦
      const quizContainer = document.querySelector('.quiz-container');
      if (quizContainer) {
        quizContainer.style.maxWidth = '100%';
        quizContainer.style.width = '100%';
        quizContainer.style.padding = '0';
      }
      
      renderQuestion();
      // renderQuestion å…§éƒ¨æœƒèª¿ç”¨ savePracticeProgress
    }

    // æ›´æ–°ç‰ˆæ¬Šå¹´ä»½
    function updateCopyrightYear() {
      const yearElement = document.getElementById('copyright-year');
      if (yearElement) {
        const currentYear = new Date().getFullYear();
        yearElement.textContent = currentYear;
      }
    }

    // æ‰‹æ©Ÿç‰ˆå´é‚Šèœå–®æ§åˆ¶å‡½æ•¸
    // ç·´ç¿’ç›®éŒ„èœå–®
    window.togglePracticeMenu = function() {
      const sidebar = document.getElementById('practice-sidebar');
      const overlay = document.getElementById('practice-menu-overlay');
      if (sidebar && overlay) {
        sidebar.classList.toggle('menu-open');
        overlay.classList.toggle('active');
        // é˜²æ­¢èƒŒæ™¯æ»¾å‹•
        if (sidebar.classList.contains('menu-open')) {
          document.body.style.overflow = 'hidden';
        } else {
          document.body.style.overflow = '';
        }
      }
    }
    
    window.closePracticeMenu = function() {
      const sidebar = document.getElementById('practice-sidebar');
      const overlay = document.getElementById('practice-menu-overlay');
      if (sidebar && overlay) {
        sidebar.classList.remove('menu-open');
        overlay.classList.remove('active');
        document.body.style.overflow = '';
      }
    }
    
    // é¡Œç›®ç›®éŒ„èœå–®
    window.toggleQuizMenu = function() {
      const sidebar = document.getElementById('quiz-sidebar');
      const overlay = document.getElementById('quiz-menu-overlay');
      if (sidebar && overlay) {
        sidebar.classList.toggle('menu-open');
        overlay.classList.toggle('active');
        // é˜²æ­¢èƒŒæ™¯æ»¾å‹•
        if (sidebar.classList.contains('menu-open')) {
          document.body.style.overflow = 'hidden';
        } else {
          document.body.style.overflow = '';
        }
      }
    }
    
    window.closeQuizMenu = function() {
      const sidebar = document.getElementById('quiz-sidebar');
      const overlay = document.getElementById('quiz-menu-overlay');
      if (sidebar && overlay) {
        sidebar.classList.remove('menu-open');
        overlay.classList.remove('active');
        document.body.style.overflow = '';
      }
    }

    // å•Ÿå‹•ç¨‹å¼
    updateCopyrightYear(); // å…ˆæ›´æ–°ç‰ˆæ¬Šå¹´ä»½
    init();

  </script>
</body>
</html>